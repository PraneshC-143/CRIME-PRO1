<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrimeScope — Modern Crime Analytics (India 2017–2023)</title>
    <meta name="description"
        content="CrimeScope: Modern, responsive crime analytics dashboard for India (2017–2023) with filters, interactive charts, table export, and a choropleth-style map." />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
                    boxShadow: {
                        glow: '0 10px 35px rgba(99,102,241,0.18), 0 0 0 1px rgba(255,255,255,0.06) inset',
                        glass: '0 12px 40px rgba(0,0,0,0.28)'
                    }
                }
            }
        }
    </script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- API Client to communicate with Python Data Backend -->
    <script src="js/api_client.js"></script>

    <style>
        :root {
            --bg0: #070A1A;
            --bg1: #0B1026;
            --card: rgba(255, 255, 255, .07);
            --card2: rgba(255, 255, 255, .09);
            --stroke: rgba(255, 255, 255, .12);
            --stroke2: rgba(255, 255, 255, .18);
            --text: rgba(255, 255, 255, .86);
            --muted: rgba(255, 255, 255, .66);
            --muted2: rgba(255, 255, 255, .52);
            --good: #ef4444;
            /* Red for crime is effectively the "primary" brand */
            --bad: #991b1b;
            --brand: #dc2626;
            /* Crimson */
            --brand2: #991b1b;
            /* Dark red */
            --warn: #f59e0b;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            color: var(--text);
            background:
                radial-gradient(1200px 700px at 15% 10%, rgba(220, 38, 38, .22), transparent 60%),
                radial-gradient(900px 600px at 85% 20%, rgba(153, 27, 27, .15), transparent 55%),
                radial-gradient(850px 700px at 60% 95%, rgba(245, 158, 11, .12), transparent 60%),
                linear-gradient(180deg, var(--bg0), var(--bg1));
            overflow-x: hidden;
        }

        .glass {
            background: linear-gradient(135deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .05));
            border: 1px solid var(--stroke);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            box-shadow: var(--tw-shadow, 0 10px 30px rgba(0, 0, 0, .25));
        }

        .glass-strong {
            background: linear-gradient(135deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
            border: 1px solid var(--stroke2);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .soft-ring {
            box-shadow: 0 0 0 1px rgba(255, 255, 255, .06) inset;
        }

        .shine {
            position: relative;
            overflow: hidden;
        }

        .shine:before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(700px 120px at 20% 10%, rgba(255, 255, 255, .18), transparent 60%);
            pointer-events: none;
            transform: translateZ(0);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: .55rem;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .88);
            padding: .7rem 1rem;
            border-radius: .9rem;
            transition: transform .15s ease, background .15s ease, border-color .15s ease;
            user-select: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, .09);
            border-color: rgba(255, 255, 255, .18);
        }

        .btn:active {
            transform: translateY(0px) scale(.99);
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(220, 38, 38, .95), rgba(153, 27, 27, .92));
            border-color: rgba(255, 255, 255, .10);
            box-shadow: 0 16px 45px rgba(220, 38, 38, .18);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, rgba(220, 38, 38, .98), rgba(153, 27, 27, .98));
        }

        option {
            background-color: #0f172a;
            /* slate-900 */
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            padding: 0.5rem;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .35rem .6rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .78);
            font-size: .8rem;
        }

        .kbd {
            font-size: .75rem;
            color: rgba(255, 255, 255, .65);
            border: 1px solid rgba(255, 255, 255, .15);
            border-bottom-color: rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .06);
            border-radius: .55rem;
            padding: .15rem .45rem;
        }

        .muted {
            color: var(--muted);
        }

        .muted2 {
            color: var(--muted2);
        }

        .gridline {
            background-image:
                linear-gradient(to right, rgba(255, 255, 255, .06) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, .06) 1px, transparent 1px);
            background-size: 64px 64px;
            mask-image: radial-gradient(circle at 20% 20%, rgba(0, 0, 0, .85), rgba(0, 0, 0, 0) 62%);
            -webkit-mask-image: radial-gradient(circle at 20% 20%, rgba(0, 0, 0, .85), rgba(0, 0, 0, 0) 62%);
        }

        .fade-in {
            animation: fadeIn .45s ease both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Leaflet glass adjustments */
        .leaflet-container {
            background: rgba(255, 255, 255, .02);
            border-radius: 1rem;
            overflow: hidden;
        }

        .leaflet-control-zoom a {
            background: rgba(15, 23, 42, .65) !important;
            color: rgba(255, 255, 255, .85) !important;
            border: 1px solid rgba(255, 255, 255, .14) !important;
            backdrop-filter: blur(10px);
        }

        .leaflet-control-zoom a:hover {
            background: rgba(15, 23, 42, .78) !important;
        }

        .leaflet-control-attribution {
            background: rgba(15, 23, 42, .35) !important;
            color: rgba(255, 255, 255, .7) !important;
            border-radius: .75rem 0 0 0;
            border: 1px solid rgba(255, 255, 255, .10);
            backdrop-filter: blur(10px);
        }

        .leaflet-tooltip {
            background: rgba(15, 23, 42, .82);
            color: rgba(255, 255, 255, .92);
            border: 1px solid rgba(255, 255, 255, .14);
            border-radius: .75rem;
            box-shadow: 0 18px 50px rgba(0, 0, 0, .35);
            padding: .5rem .6rem;
        }

        /* Mobile sidebar */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .45);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 40;
            display: none;
        }

        .overlay.show {
            display: block;
        }
    </style>
</head>

<body>
    <div class="pointer-events-none fixed inset-0 gridline opacity-70"></div>

    <!-- Topbar -->
    <header class="sticky top-0 z-50 border-b border-white/10 bg-black/15 backdrop-blur-xl">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center gap-3">
                    <button id="mobileMenuBtn" class="btn md:hidden" aria-label="Open filters">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                        Filters
                    </button>

                    <div class="flex items-center gap-3">
                        <div class="h-9 w-9 rounded-xl glass shine flex items-center justify-center shadow-glow">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M12 2l2.2 6.4L21 9l-5 3.7 1.8 6.6L12 16.9 6.2 19.3 8 12.7 3 9l6.8-.6L12 2z"
                                    stroke="rgba(255,255,255,.9)" stroke-width="1.6" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div>
                            <div class="text-base font-semibold leading-5">CrimeScope</div>
                            <div class="text-xs muted2 -mt-0.5">India Crime Analytics • 2017–2023</div>
                        </div>
                    </div>
                </div>

                <div class="hidden md:flex items-center gap-2">
                    <span class="pill">
                        <span class="h-2 w-2 rounded-full bg-emerald-400/90 shadow-glow"></span>
                        Official Dataset
                    </span>
                    <button id="jumpDashboardBtn" class="btn btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M12 3v10m0 0l4-4m-4 4l-4-4M4 17v3h16v-3" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Dashboard
                    </button>
                    <a href="analysis.html" class="btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                            <line x1="12" y1="22.08" x2="12" y2="12" />
                        </svg>
                        Detailed Analysis
                    </a>
                    <button id="downloadSampleBtn" class="btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M12 3v10m0 0l4-4m-4 4l-4-4M4 17v3h16v-3" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Landing -->
    <section id="landing" class="relative">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-10 sm:pt-14 pb-10">
            <div class="grid lg:grid-cols-12 gap-8 items-start">
                <div class="lg:col-span-7 fade-in">
                    <div class="inline-flex items-center gap-2 pill">
                        <span class="h-2 w-2 rounded-full bg-indigo-400/90"></span>
                        Glassmorphism dashboard • Interactive filters • Charts + map
                    </div>

                    <h1 class="mt-4 text-3xl sm:text-5xl font-bold tracking-tight leading-tight">
                        Crime analytics that feels <span
                            class="text-transparent bg-clip-text bg-gradient-to-r from-violet-300 via-indigo-300 to-sky-300">fast</span>,
                        <span
                            class="text-transparent bg-clip-text bg-gradient-to-r from-sky-300 to-emerald-200">clear</span>,
                        and actionable.
                    </h1>

                    <p class="mt-4 text-base sm:text-lg muted max-w-2xl">
                        Explore district-wise IPC crime patterns across India (2017–2023). Filter by state, district,
                        year range, and crime type — then drill down into trends, top regions, and distributions.
                    </p>

                    <div class="mt-6 flex flex-wrap gap-3">
                        <button id="ctaExploreBtn" class="btn btn-primary">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            Explore dashboard
                        </button>
                        <button id="ctaResetBtn" class="btn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M3 12a9 9 0 0 1 15.3-6.4M21 12a9 9 0 0 1-15.3 6.4M3 5v3h3M21 19v-3h-3"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            Reset filters
                        </button>
                        <div class="flex items-center gap-2 ml-1 text-sm muted2">
                            <span class="kbd">/</span><span>Search</span>
                            <span class="kbd">F</span><span>Filters</span>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="glass shine rounded-2xl p-4 shadow-glow soft-ring">
                            <div class="text-xs muted2">Total Crimes (filtered)</div>
                            <div id="heroTotalCrimes" class="mt-1 text-2xl font-semibold">—</div>
                            <div class="mt-2 text-xs muted2">Across selected years and regions</div>
                        </div>
                        <div
                            class="relative inline-block w-9 h-5 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="togglePrediction" id="predictionToggle"
                                class="toggle-checkbox absolute block w-3 h-3 rounded-full bg-white border-4 appearance-none cursor-pointer left-1 top-1 transition-transform duration-200"
                                checked />
                            <label for="predictionToggle"
                                class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer border border-slate-600"></label>
                        </div>
                        <div class="glass shine rounded-2xl p-4 shadow-glow soft-ring">
                            <div class="text-xs muted2">Top State (filtered)</div>
                            <div id="heroTopState" class="mt-1 text-2xl font-semibold">—</div>
                            <div id="heroTopStateMeta" class="mt-2 text-xs muted2">—</div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-5 fade-in">
                    <div class="glass-strong rounded-3xl p-5 shadow-glass soft-ring">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="text-sm font-semibold">Snapshot</div>
                                <div class="text-xs muted2 mt-0.5">What changed vs last year in selection</div>
                            </div>
                            <span class="pill">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                    <path d="M12 8v4l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor"
                                        stroke-width="2" />
                                </svg>
                                2017–2023
                            </span>
                        </div>

                        <div class="mt-4 grid grid-cols-2 gap-3">
                            <div class="glass rounded-2xl p-4 soft-ring">
                                <div class="text-xs muted2">YoY Change</div>
                                <div class="mt-2 flex items-center gap-2">
                                    <div id="heroYoyArrow"
                                        class="h-9 w-9 rounded-xl flex items-center justify-center bg-white/6 border border-white/10">
                                        —
                                    </div>
                                    <div>
                                        <div id="heroYoyValue" class="text-lg font-semibold">—</div>
                                        <div class="text-xs muted2">Latest vs previous year</div>
                                    </div>
                                </div>
                            </div>

                            <div class="glass rounded-2xl p-4 soft-ring">
                                <div class="text-xs muted2">Dominant crime</div>
                                <div id="heroDominant" class="mt-2 text-lg font-semibold">—</div>
                                <div id="heroDominantMeta" class="text-xs muted2 mt-0.5">—</div>
                            </div>
                        </div>

                        <div class="mt-4 glass rounded-2xl p-4 soft-ring">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-semibold">Trend preview</div>
                                    <div class="text-xs muted2">Total crimes by year</div>
                                </div>
                                <button id="heroFocusBtn" class="btn">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M4 13V4h9M20 11v9h-9" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" />
                                        <path d="M14 10L21 3M3 21l7-7" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    Open
                                </button>
                            </div>
                            <div class="mt-3">
                                <canvas id="heroMiniLine" height="120"></canvas>
                            </div>
                        </div>

                        <div class="mt-4 text-xs muted2">
                            Tip: Press <span class="kbd">F</span> to toggle filters. Use <span class="kbd">/</span> to
                            jump to the table search.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="relative pb-14">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex items-end justify-between gap-4">
                <div>
                    <div class="text-xl sm:text-2xl font-semibold tracking-tight">Dashboard</div>
                    <div id="activeFilterText" class="text-sm muted2 mt-1">—</div>
                </div>
                <div class="hidden sm:flex items-center gap-2">
                    <button id="exportCsvBtn" class="btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M12 3v10m0 0l4-4m-4 4l-4-4M4 17v3h16v-3" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Export CSV
                    </button>
                    <button id="exportPdfBtn" class="btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M7 3h7l3 3v15a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Z" stroke="currentColor"
                                stroke-width="2" stroke-linejoin="round" />
                            <path d="M14 3v4h4" stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                            <path d="M8 14h8M8 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        Export PDF
                    </button>
                </div>
            </div>

            <div class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Filters Sidebar -->
                <aside id="filtersPanel"
                    class="lg:col-span-3 glass-strong rounded-3xl p-5 shadow-glass soft-ring h-fit flex flex-col gap-6 sticky top-6 z-40">

                    <div class="flex items-center justify-between gap-2">
                        <div>
                            <div class="text-sm font-semibold">Filters</div>
                            <div class="text-xs muted2 mt-0.5">Refine by region, years, and crime type</div>
                        </div>
                        <button id="clearFiltersBtn"
                            class="p-1.5 text-white/50 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
                            title="Reset filters">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                <path d="M3 3v5h5"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Filter Selectors (Vertical Stack) -->
                    <div class="space-y-4">

                        <!-- State -->
                        <div class="relative">
                            <label
                                class="block text-[11px] uppercase tracking-wider text-white/50 mb-1.5 font-semibold">State</label>
                            <div class="relative">
                                <div
                                    class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-white/40">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </div>
                                <select id="stateSelect"
                                    class="w-full appearance-none rounded-2xl bg-white/5 border border-white/10 pl-9 pr-10 py-2.5 text-sm outline-none focus:border-white/20 focus:ring-2 focus:ring-indigo-400/20 text-white/90 cursor-pointer hover:bg-white/10 transition-colors">
                                    <option value="__all__">All states</option>
                                </select>
                                <div
                                    class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-white/40">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- District -->
                        <div class="relative">
                            <label
                                class="block text-[11px] uppercase tracking-wider text-white/50 mb-1.5 font-semibold">District</label>
                            <div class="relative">
                                <div
                                    class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-white/40">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </div>
                                <select id="districtSelect"
                                    class="w-full appearance-none rounded-2xl bg-white/5 border border-white/10 pl-9 pr-10 py-2.5 text-sm outline-none focus:border-white/20 focus:ring-2 focus:ring-indigo-400/20 text-white/90 cursor-pointer hover:bg-white/10 transition-colors">
                                    <option value="__all__">All districts</option>
                                </select>
                                <div
                                    class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-white/40">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Crime Type -->
                        <div class="relative">
                            <label
                                class="block text-[11px] uppercase tracking-wider text-white/50 mb-1.5 font-semibold">Crime
                                Type</label>
                            <div class="relative">
                                <div
                                    class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-white/40">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                    </svg>
                                </div>
                                <select id="crimeTypeSelect"
                                    class="w-full appearance-none rounded-2xl bg-white/5 border border-white/10 pl-9 pr-10 py-2.5 text-sm outline-none focus:border-white/20 focus:ring-2 focus:ring-indigo-400/20 text-white/90 cursor-pointer hover:bg-white/10 transition-colors">
                                    <option value="__all__">All crimes (Total)</option>
                                </select>
                                <div
                                    class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-white/40">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Years Range -->
                        <div class="relative">
                            <label
                                class="block text-[11px] uppercase tracking-wider text-white/50 mb-1.5 font-semibold">Time
                                Period</label>
                            <div
                                class="flex items-center justify-center gap-1 bg-white/5 border border-white/10 rounded-2xl px-2 hover:bg-white/10 transition-colors">
                                <div class="pl-2 flex items-center pointer-events-none text-white/40">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                </div>
                                <select id="yearFromSelect"
                                    class="appearance-none bg-transparent border-none py-2.5 px-0 text-sm outline-none text-white/90 cursor-pointer relative z-10 w-full text-center">
                                </select>
                                <span class="text-white/40 text-[10px]">—</span>
                                <select id="yearToSelect"
                                    class="appearance-none bg-transparent border-none py-2.5 px-0 text-sm outline-none text-white/90 cursor-pointer relative z-10 w-full text-center">
                                </select>
                            </div>
                        </div>

                        <div class="glass rounded-2xl p-4 soft-ring mt-6">
                            <div class="flex items-center justify-between">
                                <div class="text-xs text-white/70">Data source</div>
                                <span id="qualityPill" class="pill text-[10px] py-0.5">Local Dataset</span>
                            </div>
                            <div class="mt-2 text-[11px] text-white/50 leading-relaxed">
                                Exploring the official Indian Crime Analysis database. Map drill-downs and ML
                                Predictions active.
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="pt-4 border-t border-white/5">
                            <button id="applyFiltersBtn" class="btn btn-primary shadow-glow w-full flex justify-center">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                </svg>
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </aside>

                <!-- Main Workspace -->
                <div class="lg:col-span-9 space-y-6">
                    <!-- KPIs -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                        <div class="glass rounded-3xl p-5 shadow-glass soft-ring shine">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-xs muted2">Total crimes</div>
                                    <div id="kpiTotal" class="mt-1 text-2xl font-semibold">—</div>
                                </div>
                                <div
                                    class="h-10 w-10 rounded-2xl bg-indigo-500/15 border border-indigo-300/15 flex items-center justify-center">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M4 19V5M4 19h16M8 16v-5M12 16V8M16 16v-3" stroke="rgba(255,255,255,.9)"
                                            stroke-width="2" stroke-linecap="round" />
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center gap-2">
                                <span id="kpiTotalYoy" class="pill">—</span>
                                <span class="text-xs muted2">YoY</span>
                            </div>
                        </div>

                        <div class="glass rounded-3xl p-5 shadow-glass soft-ring shine">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-xs muted2">Crime rate (index)</div>
                                    <div id="kpiRate" class="mt-1 text-2xl font-semibold">—</div>
                                </div>
                                <div
                                    class="h-10 w-10 rounded-2xl bg-sky-500/15 border border-sky-300/15 flex items-center justify-center">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M12 3v18M4 12h16" stroke="rgba(255,255,255,.9)" stroke-width="2"
                                            stroke-linecap="round" />
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center gap-2">
                                <span id="kpiRateDelta" class="pill">—</span>
                                <span class="text-xs muted2">vs prev</span>
                            </div>
                        </div>

                        <div class="glass rounded-3xl p-5 shadow-glass soft-ring shine">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-xs muted2">Top state</div>
                                    <div id="kpiTopState" class="mt-1 text-2xl font-semibold">—</div>
                                </div>
                                <div
                                    class="h-10 w-10 rounded-2xl bg-violet-500/15 border border-violet-300/15 flex items-center justify-center">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M12 17l-5 3 1-6-4-4 6-.5L12 4l2 5.5 6 .5-4 4 1 6-5-3Z"
                                            stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linejoin="round" />
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-3 text-xs muted2">
                                <span id="kpiTopStateMeta">—</span>
                            </div>
                        </div>

                        <div class="glass rounded-3xl p-5 shadow-glass soft-ring shine">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-xs muted2">Dominant crime</div>
                                    <div id="kpiDominant" class="mt-1 text-2xl font-semibold">—</div>
                                </div>
                                <div
                                    class="h-10 w-10 rounded-2xl bg-emerald-500/12 border border-emerald-300/15 flex items-center justify-center">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M20 6L9 17l-5-5" stroke="rgba(255,255,255,.9)" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-3 text-xs muted2">
                                <span id="kpiDominantMeta">—</span>
                            </div>
                        </div>
                    </div>

                    <!-- Predictions via ML Backend -->
                    <div
                        class="glass-strong rounded-3xl p-5 shadow-glass soft-ring shine mt-6 flex justify-between items-center bg-gradient-to-r from-red-600/20 to-transparent border-red-500/30">
                        <div>
                            <div class="text-sm font-semibold flex items-center gap-2">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-red-400">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                                ML Prediction
                                (<input type="number" id="predictInputYear" value="2024" min="2024" max="2100"
                                    class="w-16 bg-transparent border-b border-white/30 text-center text-white focus:outline-none appearance-none ml-1">)
                            </div>
                            <div class="text-xs muted2 mt-1">Based on historical variance using <span id="predictModel"
                                    class="font-medium text-white/90">—</span></div>
                        </div>
                        <div class="text-right">
                            <div id="kpiPrediction"
                                class="text-3xl font-bold text-red-400 drop-shadow-[0_0_15px_rgba(239,68,68,0.5)]">—
                            </div>
                            <div class="text-xs muted2 mt-1">Predicted forward occurrences</div>
                        </div>
                    </div>

                    <!-- Map + charts -->
                    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                        <div class="xl:col-span-7 glass-strong rounded-3xl p-5 shadow-glass soft-ring">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <div class="text-sm font-semibold">India map (state intensity)</div>
                                    <div class="text-xs muted2 mt-0.5">Circle intensity approximates choropleth by state
                                        centroid</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="pill">
                                        <span class="h-2 w-2 rounded-full bg-rose-400/90"></span>
                                        Higher intensity
                                    </span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div id="map" class="h-[360px] sm:h-[420px] w-full"></div>
                            </div>
                            <div class="mt-3 text-xs muted2">
                                Tip: Click a state bubble to filter. Double-click background to clear state.
                            </div>
                        </div>

                        <div class="xl:col-span-5 space-y-6">
                            <div class="glass-strong rounded-3xl p-5 shadow-glass soft-ring">
                                <div class="flex items-start justify-between gap-3">
                                    <div>
                                        <div class="text-sm font-semibold">Crime trend (2017–2023)</div>
                                        <div class="text-xs muted2 mt-0.5">Total for selection</div>
                                    </div>
                                    <span class="pill">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                            <path d="M4 19V5M4 19h16" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" />
                                            <path d="M8 15l3-3 2 2 5-6" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        Line
                                    </span>
                                </div>
                                <div class="mt-3">
                                    <canvas id="lineChart" height="170"></canvas>
                                </div>
                            </div>

                            <div class="glass-strong rounded-3xl p-5 shadow-glass soft-ring">
                                <div class="flex items-start justify-between gap-3">
                                    <div>
                                        <div class="text-sm font-semibold">Distribution by crime type</div>
                                        <div class="text-xs muted2 mt-0.5">Share of selected total</div>
                                    </div>
                                    <span class="pill">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                            <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor"
                                                stroke-width="2" />
                                            <path d="M12 3a9 9 0 0 1 9 9h-9V3Z" stroke="currentColor" stroke-width="2"
                                                stroke-linejoin="round" />
                                        </svg>
                                        Pie
                                    </span>
                                </div>
                                <div class="mt-3">
                                    <canvas id="pieChart" height="170"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-strong rounded-3xl p-5 shadow-glass soft-ring">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="text-sm font-semibold">Top 10 regions</div>
                                <div class="text-xs muted2 mt-0.5">By total crimes within selection (state or district)
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="toggleTopModeBtn" class="btn" title="Toggle: states / districts">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M4 6h16M4 12h10M4 18h13" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                    </svg>
                                    <span id="topModeLabel">States</span>
                                </button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <canvas id="barChart" height="120"></canvas>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="glass-strong rounded-3xl p-5 shadow-glass soft-ring">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                            <div>
                                <div class="text-sm font-semibold">Raw data</div>
                                <div class="text-xs muted2 mt-0.5">Sortable + searchable • Export CSV/PDF</div>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                                <div class="relative">
                                    <input id="tableSearch"
                                        class="w-full sm:w-72 rounded-2xl bg-white/5 border border-white/10 px-3 py-2 text-sm outline-none focus:border-white/20 focus:ring-2 focus:ring-indigo-400/20"
                                        placeholder="Search state, district…" />
                                    <div class="absolute right-2 top-1/2 -translate-y-1/2 text-xs muted2">
                                        <span class="kbd">/</span>
                                    </div>
                                </div>
                                <button id="tableCsvBtn" class="btn">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M12 3v10m0 0l4-4m-4 4l-4-4M4 17v3h16v-3" stroke="currentColor"
                                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    CSV
                                </button>
                                <button id="tablePdfBtn" class="btn">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                        <path d="M7 3h7l3 3v15a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Z"
                                            stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
                                        <path d="M14 3v4h4" stroke="currentColor" stroke-width="2"
                                            stroke-linejoin="round" />
                                        <path d="M8 14h8M8 18h6" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                    </svg>
                                    PDF
                                </button>
                            </div>
                        </div>

                        <div class="mt-4 overflow-hidden rounded-2xl border border-white/10">
                            <div class="overflow-auto max-h-[520px]">
                                <table class="min-w-full text-sm">
                                    <thead class="sticky top-0 bg-black/25 backdrop-blur border-b border-white/10">
                                        <tr class="text-left">
                                            <th class="px-4 py-3 font-semibold cursor-pointer select-none"
                                                data-sort="State">State <span class="muted2" id="sortState"></span></th>
                                            <th class="px-4 py-3 font-semibold cursor-pointer select-none"
                                                data-sort="District">District <span class="muted2"
                                                    id="sortDistrict"></span></th>
                                            <th class="px-4 py-3 font-semibold cursor-pointer select-none"
                                                data-sort="Year">Year <span class="muted2" id="sortYear"></span></th>
                                            <th class="px-4 py-3 font-semibold cursor-pointer select-none"
                                                data-sort="Total">Total <span class="muted2" id="sortTotal"></span></th>
                                            <th class="px-4 py-3 font-semibold cursor-pointer select-none whitespace-nowrap"
                                                data-sort="CrimeType">Crime type (view) <span class="muted2"
                                                    id="sortCrimeType"></span></th>
                                            <th class="px-4 py-3 font-semibold cursor-pointer select-none text-right"
                                                data-sort="CrimeValue">Value <span class="muted2"
                                                    id="sortCrimeValue"></span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody" class="divide-y divide-white/8"></tbody>
                                </table>
                            </div>
                        </div>

                        <div
                            class="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs muted2">
                            <div id="tableMeta">—</div>
                            <div class="flex items-center gap-2">
                                <button id="prevPageBtn" class="btn">Prev</button>
                                <span id="pageInfo" class="pill">—</span>
                                <button id="nextPageBtn" class="btn">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Mobile overlay + drawer -->
    <div id="overlay" class="overlay"></div>
    <div id="mobileDrawer"
        class="fixed left-0 top-0 h-full w-[92%] max-w-sm z-50 -translate-x-full transition-transform duration-200 ease-out md:hidden">
        <div class="h-full glass-strong shadow-glass p-5">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm font-semibold">Filters</div>
                    <div class="text-xs muted2 mt-0.5">Tap apply to refresh</div>
                </div>
                <button id="closeDrawerBtn" class="btn" aria-label="Close">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
            </div>
            <div class="mt-4" id="drawerFiltersMount"></div>
        </div>
    </div>

    <!-- Main Application Logic -->
    <script>
        // -----------------------------
        // Populate specific dropdown definitions dynamically
        // -----------------------------
        let YEARS = [2017, 2018, 2019, 2020, 2021, 2022, 2023]; // Pre-populated, but updated by initFilters()
        const PROJECTED_YEARS = [2024, 2025, 2026, 2027, 2028, 2029, 2030];

        const CRIME_TYPES = [
            "Murder",
            "Rape",
            "Kidnapping",
            "Robbery",
            "Theft",
            "Burglary",
            "Riots",
            "Cyber Crime",
            "Domestic Violence"
        ];

        // Approximate centroids for select Indian states (for map bubbles)
        const STATE_CENTROIDS = {
            "Uttar Pradesh": [26.8467, 80.9462],
            "Bihar": [25.0961, 85.3131],
            "West Bengal": [22.9868, 87.8550],
            "Madhya Pradesh": [22.9734, 78.6569],
            "Rajasthan": [27.0238, 74.2179],
            "Tamil Nadu": [11.1271, 78.6569],
            "Karnataka": [15.3173, 75.7139],
            "Gujarat": [22.2587, 71.1924],
            "Andhra Pradesh": [15.9129, 79.7400],
            "Telangana": [18.1124, 79.0193],
            "Odisha": [20.9517, 85.0985],
            "Kerala": [10.8505, 76.2711],
            "Punjab": [31.1471, 75.3412],
            "Haryana": [29.0588, 76.0856],
            "Delhi": [28.7041, 77.1025],
            "Assam": [26.2006, 92.9376],
            "Jharkhand": [23.6102, 85.2799],
            "Chhattisgarh": [21.2787, 81.8661],
            "Uttarakhand": [30.0668, 79.0193],
            "Himachal Pradesh": [31.1048, 77.1734],
            "Jammu & Kashmir": [34.0837, 74.7973],
            "Goa": [15.2993, 74.1240]
        };

        const STATE_DISTRICTS = {
            "Uttar Pradesh": ["Lucknow", "Kanpur Nagar", "Varanasi", "Agra", "Ghaziabad"],
            "Maharashtra": ["Mumbai", "Pune", "Nagpur", "Nashik", "Thane"],
            "Bihar": ["Patna", "Gaya", "Bhagalpur", "Muzaffarpur", "Darbhanga"],
            "West Bengal": ["Kolkata", "Howrah", "North 24 Parganas", "Siliguri", "Asansol"],
            "Madhya Pradesh": ["Bhopal", "Indore", "Jabalpur", "Gwalior", "Ujjain"],
            "Rajasthan": ["Jaipur", "Jodhpur", "Kota", "Udaipur", "Ajmer"],
            "Tamil Nadu": ["Chennai", "Coimbatore", "Madurai", "Salem", "Tiruchirappalli"],
            "Karnataka": ["Bengaluru", "Mysuru", "Mangaluru", "Hubballi", "Belagavi"],
            "Gujarat": ["Ahmedabad", "Surat", "Vadodara", "Rajkot", "Bhavnagar"],
            "Andhra Pradesh": ["Visakhapatnam", "Vijayawada", "Guntur", "Nellore", "Kurnool"],
            "Telangana": ["Hyderabad", "Warangal", "Nizamabad", "Karimnagar", "Khammam"],
            "Odisha": ["Bhubaneswar", "Cuttack", "Rourkela", "Sambalpur", "Puri"],
            "Kerala": ["Thiruvananthapuram", "Kochi", "Kozhikode", "Thrissur", "Kannur"],
            "Punjab": ["Ludhiana", "Amritsar", "Jalandhar", "Patiala", "Bathinda"],
            "Haryana": ["Gurugram", "Faridabad", "Panipat", "Ambala", "Hisar"],
            "Delhi": ["New Delhi", "Central Delhi", "South Delhi", "East Delhi", "North Delhi"],
            "Assam": ["Guwahati", "Dibrugarh", "Silchar", "Jorhat", "Tezpur"],
            "Jharkhand": ["Ranchi", "Jamshedpur", "Dhanbad", "Bokaro", "Hazaribagh"],
            "Chhattisgarh": ["Raipur", "Bilaspur", "Durg", "Korba", "Jagdalpur"],
            "Uttarakhand": ["Dehradun", "Haridwar", "Nainital", "Haldwani", "Roorkee"],
            "Himachal Pradesh": ["Shimla", "Mandi", "Dharamshala", "Solan", "Kullu"],
            "Jammu & Kashmir": ["Srinagar", "Jammu", "Anantnag", "Baramulla", "Pulwama"],
            "Goa": ["Panaji", "Margao", "Vasco da Gama", "Mapusa", "Ponda"]
        };

        // Precise coordinates for demo districts found in STATE_DISTRICTS
        const DISTRICT_COORDINATES = {
            "Andaman Islands": [12.7234, 93.2425],
            "Nicobar Islands": [8.0056, 93.333],
            "Adilabad": [19.2982, 78.8652],
            "Anantapur": [14.4507, 77.6093],
            "Chittoor": [13.2983, 79.049],
            "Cuddapah": [14.4705, 78.7003],
            "East Godavari": [17.1579, 82.0466],
            "Guntur": [16.2791, 80.0441],
            "Hyderabad": [17.3844, 78.4593],
            "Karimnagar": [18.523, 79.4269],
            "Khammam": [17.6955, 80.7898],
            "Krishna": [16.4235, 80.7812],
            "Kurnool": [15.526, 77.9478],
            "Mahbubnagar": [16.5302, 78.2325],
            "Medak": [17.8495, 78.2845],
            "Nalgonda": [17.0839, 79.3385],
            "Nellore": [14.2386, 79.6895],
            "Nizamabad": [18.5382, 78.0966],
            "Prakasam": [15.627, 79.6033],
            "Rangareddi": [17.2759, 78.1045],
            "Srikakulam": [18.6162, 84.0836],
            "Vishakhapatnam": [17.8924, 82.6678],
            "Vizianagaram": [18.4868, 83.4038],
            "Warangal": [17.9591, 79.7404],
            "West Godavari": [16.9049, 81.3565],
            "Changlang": [27.2881, 96.4046],
            "East Kameng": [27.3287, 92.9905],
            "East Siang": [28.1513, 95.1563],
            "Kurung Kumey": [27.9815, 93.2859],
            "Lohit": [28.0087, 96.5867],
            "Lower Dibang Valley": [28.3131, 95.8467],
            "Lower Subansiri": [27.6793, 93.8743],
            "Papum Pare": [27.2902, 93.7109],
            "Tawang": [27.6621, 91.9299],
            "Tirap": [26.9633, 95.4697],
            "Upper Dibang Valley": [29.0129, 95.9292],
            "Upper Siang": [28.7486, 94.7908],
            "Upper Subansiri": [28.2368, 93.8883],
            "West Kameng": [27.4338, 92.6237],
            "West Siang": [28.2824, 94.4591],
            "Barpeta": [26.4547, 90.9757],
            "Bongaigaon": [26.4694, 90.6504],
            "Cachar": [24.7609, 92.8435],
            "Darrang": [26.5672, 92.0438],
            "Dhemaji": [27.5839, 94.8653],
            "Dhuburi": [25.9433, 90.0873],
            "Dibrugarh": [27.4057, 95.0302],
            "Goalpara": [26.0562, 90.6079],
            "Golaghat": [26.3736, 93.7333],
            "Hailakandi": [24.5075, 92.5996],
            "Jorhat": [26.7695, 94.2816],
            "Kamrup": [26.2605, 91.557],
            "Karbi Anglong": [26.0735, 93.0233],
            "Karimganj": [24.5847, 92.4009],
            "Kokrajhar": [26.5994, 90.1885],
            "Lakhimpur": [27.1749, 94.1482],
            "Marigaon": [26.2906, 92.2604],
            "Nagaon": [26.2086, 92.8624],
            "Nalbari": [26.4863, 91.4609],
            "North Cachar Hills": [25.3985, 93.0014],
            "Sibsagar": [26.9988, 94.8871],
            "Sonitpur": [26.7679, 93.0556],
            "Tinsukia": [27.6034, 95.6208],
            "Araria": [26.2647, 87.3612],
            "Aurangabad": [20.0256, 75.2456],
            "Banka": [24.8303, 86.8274],
            "Begusarai": [25.5133, 86.1186],
            "Bhabua": [24.9762, 83.6041],
            "Bhagalpur": [25.2862, 87.09],
            "Bhojpur": [25.4508, 84.5565],
            "Buxar": [25.5061, 84.0752],
            "Darbhanga": [26.1583, 86.0322],
            "Gaya": [24.6805, 84.8379],
            "Gopalganj": [26.4248, 84.4014],
            "Jamui": [24.7563, 86.2159],
            "Jehanabad": [25.1514, 84.8261],
            "Katihar": [25.5404, 87.6358],
            "Khagaria": [25.4915, 86.5636],
            "Kishanganj": [26.2443, 87.9453],
            "Lakhisarai": [25.1582, 86.1529],
            "Madhepura": [25.7821, 86.8554],
            "Madhubani": [26.3556, 86.2308],
            "Munger": [25.2225, 86.514],
            "Muzaffarpur": [26.1486, 85.3072],
            "Nalanda": [25.214, 85.538],
            "Nawada": [24.8189, 85.6568],
            "Pashchim Champaran": [27.0534, 84.2914],
            "Patna": [25.4676, 85.3693],
            "Purba Champaran": [26.6389, 84.8837],
            "Purnia": [25.7794, 87.4221],
            "Rohtas": [24.9403, 83.9755],
            "Saharsa": [25.8375, 86.5868],
            "Samastipur": [25.7777, 85.9676],
            "Saran": [25.9239, 84.7984],
            "Sheikhpura": [25.1255, 85.7777],
            "Sheohar": [26.4868, 85.3206],
            "Sitamarhi": [27.0613, 86.2687],
            "Siwan": [26.133, 84.3881],
            "Supaul": [26.2777, 86.7472],
            "Vaishali": [25.7509, 85.3459],
            "Chandigarh": [30.7342, 76.7635],
            "Bastar": [19.3931, 81.4477],
            "Bilaspur": [31.4074, 76.6465],
            "Dantewada": [18.5919, 81.097],
            "Dhamtari": [20.5327, 81.7859],
            "Durg": [21.1995, 81.3669],
            "Janjgir-Champa": [21.9667, 82.8076],
            "Jashpur": [22.767, 83.8883],
            "Kanker": [20.1219, 81.102],
            "Kawardha": [22.1129, 81.1875],
            "Korba": [22.5166, 82.624],
            "Koriya": [23.4316, 82.1609],
            "Mahasamund": [21.1846, 82.6294],
            "Raigarh": [18.492, 73.244],
            "Raipur": [20.8268, 82.2524],
            "Raj Nandgaon": [20.9712, 80.7966],
            "Surguja": [23.3658, 83.2808],
            "Dadra And Nagar Haveli": [20.2062, 73.0757],
            "Daman": [20.4198, 72.8484],
            "Junagadh": [21.1896, 70.6108],
            "Delhi": [28.6465, 77.0853],
            "North Goa": [15.5327, 73.9833],
            "South Goa": [15.1926, 74.0512],
            "Ahmadabad": [22.759, 72.2353],
            "Amreli": [21.4262, 71.2486],
            "Anand": [22.4669, 72.7942],
            "Banas Kantha": [24.2657, 72.1514],
            "Bharuch": [21.8336, 73.0067],
            "Bhavnagar": [21.6721, 71.8985],
            "Dahod": [22.9561, 74.0279],
            "Gandhinagar": [23.2113, 72.6909],
            "Jamnagar": [22.3273, 69.8069],
            "Kachchh": [23.7043, 69.9568],
            "Kheda": [22.8939, 73.0486],
            "Mahesana": [23.5658, 72.4188],
            "Narmada": [21.6884, 73.6494],
            "Navsari": [20.8255, 73.1151],
            "Panch Mahals": [22.872, 73.6456],
            "Patan": [23.7683, 71.7903],
            "Porbandar": [21.5874, 69.7827],
            "Rajkot": [22.3442, 70.7857],
            "Sabar Kantha": [23.7771, 73.1954],
            "Surat": [21.1903, 73.4571],
            "Surendranagar": [22.8235, 71.5789],
            "The Dangs": [20.7872, 73.7122],
            "Vadodara": [22.315, 73.584],
            "Valsad": [20.4328, 73.1192],
            "Ambala": [30.3818, 76.9216],
            "Bhiwani": [28.7362, 75.9613],
            "Faridabad": [28.1815, 77.304],
            "Fatehabad": [29.5387, 75.5817],
            "Gurgaon": [28.0994, 76.9829],
            "Hisar": [29.2432, 75.7812],
            "Jhajjar": [28.5985, 76.6151],
            "Jind": [29.4548, 76.3352],
            "Kaithal": [29.8606, 76.4551],
            "Karnal": [29.7206, 76.8465],
            "Kurukshetra": [30.0574, 76.8428],
            "Mahendragarh": [28.1397, 76.1387],
            "Panchkula": [30.7275, 76.9625],
            "Panipat": [29.3318, 76.8894],
            "Rewari": [28.2022, 76.5769],
            "Rohtak": [28.8973, 76.551],
            "Sirsa": [29.6097, 74.8788],
            "Sonepat": [29.0562, 76.8435],
            "Yamuna Nagar": [30.2562, 77.3268],
            "Chamba": [32.6953, 76.327],
            "Hamirpur": [25.7864, 79.8483],
            "Kangra": [32.0805, 76.3215],
            "Kinnaur": [31.5987, 78.3659],
            "Kullu": [31.882, 77.3879],
            "Lahul And Spiti": [32.5034, 77.5047],
            "Mandi": [31.6546, 76.9911],
            "Shimla": [31.2438, 77.6384],
            "Sirmaur": [30.7055, 77.4085],
            "Solan": [31.061, 76.9137],
            "Una": [31.585, 76.1934],
            "Anantnag (Kashmir South)": [33.8715, 75.2184],
            "Bagdam": [33.9195, 74.7688],
            "Baramula (Kashmir North)": [34.3617, 74.6834],
            "Doda": [33.5379, 75.9895],
            "Jammu": [32.7287, 74.8736],
            "Kargil": [33.776, 76.5011],
            "Kathua": [32.5723, 75.5614],
            "Kupwara (Muzaffarabad)": [34.5525, 74.2056],
            "Ladakh (Leh)": [33.9221, 77.9465],
            "Pulwama": [33.8471, 74.9831],
            "Punch": [33.743, 74.3055],
            "Rajauri": [33.2624, 74.4079],
            "Srinagar": [34.2516, 75.1323],
            "Udhampur": [33.067, 75.237],
            "Bokaro": [23.6933, 86.0216],
            "Chatra": [24.1034, 84.8913],
            "Deoghar": [24.3314, 86.7589],
            "Dhanbad": [23.8433, 86.4641],
            "Dumka": [24.3106, 87.288],
            "Garhwa": [24.0503, 83.6929],
            "Giridih": [24.3328, 86.1165],
            "Godda": [24.8639, 87.2808],
            "Gumla": [23.1572, 84.5194],
            "Hazaribag": [23.9822, 85.4696],
            "Jamtara": [23.981, 86.8797],
            "Koderma": [24.5542, 85.6734],
            "Latehar": [23.6856, 84.4623],
            "Lohardaga": [23.4769, 84.6635],
            "Pakur": [24.5312, 87.6489],
            "Palamu": [24.1898, 84.1933],
            "Pashchim Singhbhum": [22.4246, 85.5116],
            "Purba Singhbhum": [22.6106, 86.4752],
            "Ranchi": [23.141, 85.3792],
            "Sahibganj": [25.031, 87.7113],
            "Saraikela Kharsawan": [22.8155, 85.8746],
            "Simdega": [22.5854, 84.5371],
            "Bagalkot": [16.288, 75.6649],
            "Bangalore Rural": [12.8641, 77.5105],
            "Bangalore Urban": [12.9358, 77.5739],
            "Belgaum": [16.1555, 74.7793],
            "Bellary": [15.1929, 76.4149],
            "Bidar": [18.018, 77.172],
            "Bijapur": [16.8121, 75.9026],
            "Chamrajnagar": [11.9393, 77.0824],
            "Chikmagalur": [13.4022, 75.7203],
            "Chitradurga": [14.2996, 76.5214],
            "Dakshin Kannad": [12.8169, 75.2222],
            "Davanagere": [14.3107, 75.9654],
            "Dharwad": [15.367, 75.1444],
            "Gadag": [15.4119, 75.6608],
            "Gulbarga": [16.9781, 76.8773],
            "Hassan": [13.0239, 76.0914],
            "Haveri": [14.7137, 75.4197],
            "Kodagu": [12.3754, 75.7743],
            "Kolar": [13.3516, 77.9664],
            "Koppal": [15.5701, 76.2915],
            "Mandya": [12.6289, 76.8252],
            "Mysore": [12.1901, 76.5163],
            "Raichur": [16.0498, 76.9133],
            "Shimoga": [14.0528, 75.1823],
            "Tumkur": [13.5379, 76.9261],
            "Udupi": [13.4805, 74.892],
            "Uttar Kannand": [14.7227, 74.5813],
            "Alappuzha": [9.4949, 76.4751],
            "Ernakulam": [9.9816, 76.2999],
            "Idukki": [9.8043, 77.0071],
            "Kannur": [11.982, 75.5519],
            "Kasaragod": [12.4203, 75.1485],
            "Kollam": [8.9583, 76.8597],
            "Kottayam": [9.6217, 76.6698],
            "Kozhikode": [11.4615, 75.8336],
            "Malappuram": [11.0992, 76.1829],
            "Palakkad": [10.7791, 76.4582],
            "Pattanamtitta": [9.2718, 76.8652],
            "Thiruvananthapuram": [8.5749, 76.9709],
            "Thrissur": [10.472, 76.4244],
            "Wayanad": [11.7067, 76.1039],
            "Kavaratti": [9.9861, 72.9014],
            "Anuppur": [23.1503, 81.8605],
            "Ashoknagar": [24.6234, 77.87],
            "Balaghat": [21.8589, 80.2731],
            "Barwani": [21.7544, 75.0331],
            "Betul": [21.8819, 77.7989],
            "Bhind": [26.3552, 78.6689],
            "Bhopal": [23.4966, 77.4057],
            "Burhanpur": [21.3377, 76.3701],
            "Chhatarpur": [24.7657, 79.7028],
            "Chhindwara": [22.141, 78.8234],
            "Damoh": [23.8, 79.4999],
            "Datia": [25.9235, 78.5479],
            "Dewas": [22.8102, 76.5115],
            "Dhar": [22.5808, 75.0943],
            "Dindori": [22.8068, 81.1024],
            "East Nimar": [21.9808, 76.6209],
            "Guna": [24.5045, 77.2655],
            "Gwalior": [26.0344, 78.1527],
            "Harda": [22.2479, 77.1394],
            "Hoshangabad": [22.6043, 77.9475],
            "Indore": [22.7145, 75.8336],
            "Jabalpur": [23.151, 79.9611],
            "Jhabua": [22.5833, 74.5245],
            "Katni": [23.7205, 80.372],
            "Mandla": [22.6896, 80.4727],
            "Mandsaur": [24.2647, 75.4026],
            "Morena": [26.3908, 77.8222],
            "Narsinghpur": [22.9367, 79.0353],
            "Neemuch": [24.6498, 75.1607],
            "Panna": [24.4523, 80.2002],
            "Raisen": [23.2711, 78.0833],
            "Rajgarh": [23.8724, 76.7122],
            "Ratlam": [23.5056, 75.1039],
            "Rewa": [24.7598, 81.6688],
            "Sagar": [23.8132, 78.6994],
            "Satna": [24.5818, 80.8653],
            "Sehore": [23.1264, 77.2365],
            "Seoni": [22.2738, 79.7389],
            "Shahdol": [23.4655, 81.4843],
            "Shajapur": [23.7203, 76.3663],
            "Sheopur": [25.7502, 77.0695],
            "Shivpuri": [25.3808, 77.7338],
            "Sidhi": [24.2453, 82.0531],
            "Tikamgarh": [25.002, 78.8847],
            "Ujjain": [23.2981, 75.6918],
            "Umaria": [23.6461, 80.892],
            "Vidisha": [23.851, 77.7742],
            "West Nimar": [21.9633, 75.7237],
            "Ahmednagar": [19.1595, 74.5874],
            "Akola": [20.7636, 77.1399],
            "Amravati": [21.1561, 77.5356],
            "Bhandara": [21.1211, 80.0585],
            "Bid": [18.9747, 75.7763],
            "Buldana": [20.565, 76.3743],
            "Chandrapur": [20.0946, 79.3926],
            "Dhule": [21.1337, 74.5323],
            "Garhchiroli": [19.7529, 80.3148],
            "Gondiya": [21.1433, 80.1737],
            "Greater Bombay": [19.1031, 72.9501],
            "Hingoli": [19.5422, 77.0829],
            "Jalgaon": [20.844, 75.5814],
            "Jalna": [19.9626, 76.0616],
            "Kolhapur": [16.4591, 74.2025],
            "Latur": [18.3518, 76.7491],
            "Nagpur": [21.1521, 78.9507],
            "Nanded": [19.0955, 77.6499],
            "Nandurbar": [21.5121, 74.1818],
            "Nashik": [20.2263, 74.1003],
            "Osmanabad": [18.1694, 76.0381],
            "Parbhani": [19.3081, 76.6637],
            "Pune": [18.6432, 74.25],
            "Ratnagiri": [17.2803, 73.4516],
            "Sangli": [17.1705, 74.6919],
            "Satara": [17.6363, 74.2273],
            "Sindhudurg": [16.1329, 73.7638],
            "Solapur": [17.8335, 75.5214],
            "Thane": [19.6449, 73.2284],
            "Wardha": [20.8254, 78.6351],
            "Washim": [20.304, 77.1465],
            "Yavatmal": [20.064, 78.2142],
            "Bishnupur": [24.5163, 93.8019],
            "Chandel": [24.2418, 94.0759],
            "Churachandpur": [24.3297, 93.428],
            "East Imphal": [24.8096, 93.611],
            "Senapati": [25.1089, 94.0802],
            "Tamenglong": [24.9816, 93.5526],
            "Thoubal": [24.4869, 93.9982],
            "Ukhrul": [25.0936, 94.4366],
            "West Imphal": [24.8186, 93.8821],
            "East Garo Hills": [25.7152, 90.5701],
            "East Khasi Hills": [25.4045, 91.7559],
            "Jaintia Hills": [25.3927, 92.3941],
            "Ri-Bhoi": [25.88, 91.8218],
            "South Garo Hills": [25.3493, 90.6186],
            "West Garo Hills": [25.577, 90.1314],
            "West Khasi Hills": [25.5125, 91.2894],
            "Aizawl": [23.8623, 92.9175],
            "Champhai": [23.5456, 93.2257],
            "Kolasib": [24.2385, 92.7166],
            "Lawngtlai": [22.3695, 92.7368],
            "Lunglei": [22.9531, 92.7647],
            "Mamit": [23.7559, 92.468],
            "Saiha": [22.3784, 93.0181],
            "Serchhip": [23.3123, 92.9375],
            "Dimapur": [25.8051, 93.7721],
            "Kohima": [25.6157, 93.8104],
            "Mokokchung": [26.4831, 94.5261],
            "Mon": [26.666, 95.0139],
            "Phek": [25.6513, 94.5476],
            "Tuensang": [26.1973, 94.8754],
            "Wokha": [26.2447, 94.173],
            "Zunheboto": [26.0293, 94.4666],
            "Angul": [21.0974, 84.8243],
            "Baleshwar": [21.5142, 86.9174],
            "Baragarh": [21.2309, 83.2695],
            "Bhadrak": [20.978, 86.6442],
            "Bolangir": [20.6042, 83.1749],
            "Boudh": [20.639, 84.1774],
            "Cuttack": [20.3623, 85.5618],
            "Deogarh": [21.4335, 84.8411],
            "Dhenkanal": [20.8292, 85.5685],
            "Gajapati": [19.1863, 84.1145],
            "Ganjam": [19.625, 84.6518],
            "Jagatsinghpur": [20.1764, 86.3642],
            "Jajpur": [20.8673, 86.15],
            "Jharsuguda": [21.7985, 83.9031],
            "Kalahandi": [19.813, 83.1522],
            "Kandhamal": [20.1265, 84.0345],
            "Kendrapara": [20.5428, 86.6701],
            "Keonjhar": [21.5834, 85.7754],
            "Khordha": [20.0472, 85.5033],
            "Koraput": [18.731, 82.7464],
            "Malkangiri": [18.2677, 81.912],
            "Mayurbhanj": [21.9118, 86.4189],
            "Nabarangpur": [19.6216, 82.343],
            "Nayagarh": [20.2324, 84.9648],
            "Nuapada": [20.5363, 82.5897],
            "Puri": [19.825, 85.7296],
            "Rayagada": [19.4339, 83.4479],
            "Sambalpur": [21.5523, 84.2795],
            "Sonepur": [20.8485, 83.8595],
            "Sundargarh": [22.0567, 84.4518],
            "Karaikal": [10.9001, 79.7787],
            "Mahe": [12.0485, 75.3118],
            "Puducherry": [11.9138, 79.74],
            "Yanam": [16.7207, 82.2387],
            "Amritsar": [31.5681, 74.9462],
            "Bathinda": [30.1796, 74.9945],
            "Faridkot": [30.599, 74.7519],
            "Fatehgarh Sahib": [30.665, 76.3229],
            "Firozpur": [30.5546, 74.4936],
            "Gurdaspur": [32.0856, 75.4046],
            "Hoshiarpur": [31.6087, 75.8994],
            "Jalandhar": [31.2943, 75.5023],
            "Kapurthala": [31.386, 75.4169],
            "Ludhiana": [30.7922, 75.8401],
            "Mansa": [29.8791, 75.4618],
            "Moga": [30.7932, 75.151],
            "Muktsar": [30.2856, 74.5264],
            "Nawan Shehar": [31.1295, 76.1391],
            "Patiala": [30.2411, 76.4515],
            "Rupnagar": [31.0071, 76.5621],
            "Sangrur": [30.2108, 75.7189],
            "Ajmer": [26.3162, 74.6286],
            "Alwar": [27.6438, 76.6597],
            "Banswara": [23.4949, 74.3758],
            "Baran": [24.923, 76.816],
            "Barmer": [25.5754, 71.4723],
            "Bharatpur": [27.2672, 77.3141],
            "Bhilwara": [25.4915, 74.7365],
            "Bikaner": [28.1186, 73.0419],
            "Bundi": [25.4433, 75.7912],
            "Chittaurgarh": [24.3772, 74.9629],
            "Churu": [28.2068, 74.6494],
            "Dausa": [26.81, 76.6117],
            "Dhaulpur": [26.6598, 77.7412],
            "Dungarpur": [23.6787, 73.8732],
            "Ganganagar": [29.4531, 73.4818],
            "Hanumangarh": [29.367, 74.7398],
            "Jaipur": [27.156, 75.5994],
            "Jaisalmer": [26.9479, 70.9127],
            "Jalor": [25.2059, 72.1478],
            "Jhalawar": [24.3186, 76.2004],
            "Jhunjhunun": [28.0838, 75.5567],
            "Jodhpur": [26.7336, 72.8303],
            "Karauli": [26.5013, 76.9164],
            "Kota": [25.1958, 76.0995],
            "Nagaur": [27.0594, 74.238],
            "Pali": [25.6103, 73.5894],
            "Rajsamand": [25.2682, 73.8982],
            "Sawai Madhopur": [26.2003, 76.4709],
            "Sikar": [27.6652, 75.3826],
            "Sirohi": [24.8064, 72.7087],
            "Tonk": [26.1244, 75.716],
            "Udaipur": [24.4577, 73.7961],
            "East": [27.2801, 88.6795],
            "North Sikkim": [27.7547, 88.4997],
            "South Sikkim": [27.3049, 88.3964],
            "West Sikkim": [27.3629, 88.1851],
            "Ariyalur": [11.1377, 79.2102],
            "Chennai": [13.0827, 80.2707],
            "Coimbatore": [11.0168, 76.9558],
            "Cuddalore": [11.5044, 79.3375],
            "Dharmapuri": [12.3196, 78.0985],
            "Dindigul": [10.4152, 77.7873],
            "Erode": [11.2697, 77.3731],
            "Kancheepuram": [12.6716, 79.9045],
            "Kanniyakumari": [8.3238, 77.3329],
            "Karur": [10.8089, 78.1538],
            "Madurai": [9.9251, 77.9512],
            "Nagapattinam": [10.846, 79.6886],
            "Namakkal": [11.2909, 78.0718],
            "Nilgiris": [11.4391, 76.6158],
            "Perambalur": [11.2732, 78.8863],
            "Pudukkottai": [10.2754, 78.8505],
            "Ramanathapuram": [9.5063, 78.8637],
            "Salem": [11.6331, 78.2341],
            "Sivaganga": [9.9504, 78.5524],
            "Thanjavur": [10.6454, 79.1598],
            "Theni": [9.8569, 77.4329],
            "Thiruvallur": [13.2353, 79.8101],
            "Thiruvarur": [10.6374, 79.5396],
            "Thoothukudi": [8.8355, 78.0115],
            "Tiruchchirappalli": [10.8365, 78.5746],
            "Tirunelveli Kattabo": [8.7705, 77.5478],
            "Tiruvannamalai": [12.4137, 79.1816],
            "Vellore": [12.721, 79.0865],
            "Villupuram": [11.9631, 79.3103],
            "Virudhunagar": [9.4808, 77.8621],
            "Dhalai": [23.8421, 91.9598],
            "North Tripura": [24.0956, 92.1195],
            "South Tripura": [23.354, 91.6089],
            "West Tripura": [23.7522, 91.4707],
            "Agra": [27.024, 78.1301],
            "Aligarh": [27.8793, 78.0402],
            "Allahabad": [25.2825, 81.9282],
            "Ambedkar Nagar": [26.4101, 82.6686],
            "Auraiya": [26.6608, 79.3983],
            "Azamgarh": [26.0463, 83.0792],
            "Badaun": [28.073, 78.8825],
            "Baghpat": [29.0417, 77.3001],
            "Bahraich": [27.7367, 81.4143],
            "Ballia": [25.878, 84.1496],
            "Balrampur": [27.449, 82.3859],
            "Banda": [25.4592, 80.5635],
            "Bara Banki": [26.9438, 81.3852],
            "Bareilly": [28.4595, 79.3677],
            "Basti": [26.7822, 82.5912],
            "Bijnor": [29.4157, 78.4523],
            "Bulandshahr": [28.3971, 78.0306],
            "Chandauli": [25.1253, 83.2753],
            "Chitrakoot": [25.2202, 81.1182],
            "Deoria": [26.4265, 83.8261],
            "Etah": [27.6828, 78.7181],
            "Etawah": [26.7494, 79.0372],
            "Faizabad": [26.6251, 82.0686],
            "Farrukhabad": [27.4423, 79.4256],
            "Fatehpur": [25.8377, 80.7674],
            "Firozabad": [27.1994, 78.3827],
            "Gautam Buddha Nagar": [28.3842, 77.5234],
            "Ghaziabad": [28.7418, 77.6966],
            "Ghazipur": [25.6024, 83.5056],
            "Gonda": [27.115, 82.052],
            "Gorakhpur": [26.612, 83.3622],
            "Hardoi": [27.3415, 80.248],
            "Hathras": [27.5579, 78.1942],
            "Jalaun": [26.1114, 79.4361],
            "Jaunpur": [25.7975, 82.5971],
            "Jhansi": [25.5331, 78.8535],
            "Jyotiba Phule Nagar": [28.7943, 78.3736],
            "Kannauj": [27.0034, 79.6605],
            "Kanpur Dehat": [26.4443, 79.9804],
            "Kanpur": [26.411, 80.337],
            "Kaushambi": [25.5383, 81.5228],
            "Kushinagar": [26.9256, 83.9665],
            "Lakhimpur Kheri": [28.185, 80.6561],
            "Lalitpur": [24.7031, 78.5756],
            "Lucknow": [26.8353, 80.88],
            "Maharajganj": [27.1861, 83.5193],
            "Mahoba": [25.365, 79.7057],
            "Mainpuri": [27.2059, 79.0555],
            "Mathura": [27.6048, 77.6236],
            "Mau": [26.0407, 83.4866],
            "Meerut": [29.0049, 77.7854],
            "Mirzapur": [24.9376, 82.6257],
            "Moradabad": [28.8139, 78.6756],
            "Muzaffarnagar": [29.4504, 77.6052],
            "Pilibhit": [28.5072, 80.0052],
            "Pratapgarh": [25.8771, 81.8733],
            "Rae Bareli": [26.2119, 81.1387],
            "Rampur": [28.7816, 79.115],
            "Saharanpur": [29.9894, 77.5222],
            "Sant Kabir Nagar": [26.7308, 83.0181],
            "Sant Ravi Das Nagar": [25.3614, 82.4444],
            "Shahjahanpur": [27.9701, 79.8406],
            "Shravasti": [27.6326, 81.8173],
            "Siddharth Nagar": [27.2101, 82.8621],
            "Sitapur": [27.5081, 80.8509],
            "Sonbhadra": [24.3901, 83.0301],
            "Sultanpur": [26.3222, 82.1059],
            "Unnao": [26.5775, 80.5419],
            "Varanasi": [25.376, 82.9244],
            "Almora": [29.7103, 79.5419],
            "Bageshwar": [30.0057, 79.8019],
            "Chamoli": [30.5063, 79.5533],
            "Champawat": [29.2921, 80.0532],
            "Dehra Dun": [30.4639, 77.9306],
            "Haridwar": [29.8983, 78.0169],
            "Naini Tal": [29.3015, 79.3999],
            "Pauri Garhwal": [29.8865, 78.7011],
            "Pithoragarh": [30.1259, 80.4144],
            "Rudra Prayag": [30.5533, 79.1191],
            "Tehri Garhwal": [30.4717, 78.4866],
            "Udham Singh Nagar": [29.0505, 79.4369],
            "Uttarkashi": [30.9731, 78.5628],
            "Bankura": [23.1304, 87.1835],
            "Barddhaman": [23.4054, 87.6035],
            "Birbhum": [24.06, 87.5537],
            "Dakshin Dinajpur": [25.3818, 88.5945],
            "Darjiling": [26.8336, 88.4344],
            "East Midnapore": [22.0596, 87.8088],
            "Haora": [22.498, 88.1036],
            "Hugli": [22.9095, 88.0037],
            "Jalpaiguri": [26.6645, 89.1339],
            "Kochbihar": [26.2552, 89.3029],
            "Kolkata": [22.5623, 88.339],
            "Maldah": [25.0972, 88.111],
            "Murshidabad": [24.2863, 88.2759],
            "Nadia": [23.4852, 88.4667],
            "North 24 Parganas": [22.3999, 88.7137],
            "Puruliya": [23.1994, 86.3602],
            "South 24 Parganas": [22.0808, 88.418],
            "Uttar Dinajpur": [25.8698, 88.1644],
            "West Midnapore": [22.3548, 87.2218],
            "Bengaluru Urban": [12.9358, 77.5739],
            "Bengaluru Rural": [12.8641, 77.5105]
        };

        function mulberry32(seed) {
            return function () {
                let t = seed += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
        function formatInt(n) { return (n ?? 0).toLocaleString('en-IN'); }
        function formatPct(n) {
            if (!isFinite(n)) return "—";
            const s = (n >= 0 ? "+" : "") + n.toFixed(1) + "%";
            return s;
        }

        // Synthetic population baseline per state (for "rate index")
        const STATE_POP = {};
        (function initPop() {
            const rng = mulberry32(42);
            Object.keys(STATE_DISTRICTS).forEach((s, i) => {
                // 10M - 220M
                STATE_POP[s] = Math.round((10 + rng() * 210) * 1e6);
            });
        })();

        // Will be populated dynamically by Python Backend API
        let DATA = [];

        // -----------------------------
        // State
        // -----------------------------
        const state = {
            filters: {
                state: "__all__",
                district: "__all__",
                crimeType: "__all__",
                yearFrom: YEARS[0],
                yearTo: YEARS[YEARS.length - 1]
            },
            topMode: "state", // or "district"
            sort: { key: "Total", dir: "desc" },
            page: 1,
            pageSize: 18,
            tableSearch: ""
        };

        // -----------------------------
        // DOM helpers
        // -----------------------------
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const setTxt = (sel, txt) => { const el = $(sel); if (el) el.textContent = txt; };

        // -----------------------------
        // Populate selects
        // -----------------------------
        function initFilters() {
            const stateSelect = $("#stateSelect");
            const districtSelect = $("#districtSelect");
            const crimeTypeSelect = $("#crimeTypeSelect");
            const yFrom = $("#yearFromSelect");
            const yTo = $("#yearToSelect");

            // Extract boundaries from real Python DATA array
            if (DATA && DATA.length > 0) {
                const datasetYears = Array.from(new Set(DATA.map(d => parseInt(d.Year)))).sort();
                if (datasetYears.length > 0) YEARS = datasetYears;
            }

            // Update filter defaults to match valid dataset years
            state.filters.yearFrom = YEARS[0];
            state.filters.yearTo = YEARS[YEARS.length - 1];

            // states
            const states = Array.from(new Set(DATA.map(d => d.State))).sort();
            for (const s of states) {
                const opt = document.createElement("option");
                opt.value = s; opt.textContent = s;
                stateSelect.appendChild(opt);
            }

            // crime types
            for (const ct of CRIME_TYPES) {
                const opt = document.createElement("option");
                opt.value = ct; opt.textContent = ct;
                crimeTypeSelect.appendChild(opt);
            }

            // years
            for (const y of YEARS) {
                const o1 = document.createElement("option");
                o1.value = y; o1.textContent = y;
                yFrom.appendChild(o1);

                const o2 = document.createElement("option");
                o2.value = y; o2.textContent = y;
                yTo.appendChild(o2);
            }

            // defaults
            yFrom.value = state.filters.yearFrom;
            yTo.value = state.filters.yearTo;

            // district based on state
            function refreshDistricts() {
                const s = stateSelect.value;
                districtSelect.innerHTML = "";
                const all = document.createElement("option");
                all.value = "__all__"; all.textContent = "All districts";
                districtSelect.appendChild(all);
                const districts = (s === "__all__")
                    ? Array.from(new Set(DATA.map(d => d.District))).sort()
                    : Array.from(new Set(DATA.filter(r => r.State === s).map(r => r.District))).sort();
                for (const d of districts) {
                    const opt = document.createElement("option");
                    opt.value = d; opt.textContent = d;
                    districtSelect.appendChild(opt);
                }
                // keep if possible
                if ([...districtSelect.options].some(o => o.value === state.filters.district)) {
                    districtSelect.value = state.filters.district;
                } else {
                    districtSelect.value = "__all__";
                    state.filters.district = "__all__";
                }
            }

            stateSelect.addEventListener("change", () => {
                refreshDistricts();
            });
            refreshDistricts();
        }

        // -----------------------------
        // Filtering & aggregation
        // -----------------------------
        function applyCurrentFilters() {
            const f = state.filters;
            let rows = DATA.slice();

            // years (ensure parsed as int for safety from JSON payload)
            rows = rows.filter(r => parseInt(r.Year) >= parseInt(f.yearFrom) && parseInt(r.Year) <= parseInt(f.yearTo));
            // state / district 
            if (f.state !== "__all__") rows = rows.filter(r => r.State === f.state);
            if (f.district !== "__all__") rows = rows.filter(r => r.District === f.district);

            return rows;
        }

        function totalForRow(row, crimeType) {
            if (crimeType === "__all__") return row.Total;
            return row[crimeType] ?? 0;
        }

        function sumTotal(rows, crimeType) {
            return rows.reduce((a, r) => a + totalForRow(r, crimeType), 0);
        }

        function groupBy(rows, key, crimeType) {
            const m = new Map();
            for (const r of rows) {
                const k = r[key];
                m.set(k, (m.get(k) ?? 0) + totalForRow(r, crimeType));
            }
            return m;
        }

        function seriesByYear(rows, crimeType) {
            const m = new Map(YEARS.map(y => [y, 0]));
            for (const r of rows) {
                m.set(r.Year, (m.get(r.Year) ?? 0) + totalForRow(r, crimeType));
            }
            // only selected range
            const arr = [];
            for (const y of YEARS) {
                if (y < state.filters.yearFrom || y > state.filters.yearTo) continue;
                arr.push({ year: y, value: m.get(y) ?? 0 });
            }
            return arr;
        }

        function crimeTypeDistribution(rows) {
            const dist = CRIME_TYPES.map(ct => ({ type: ct, value: rows.reduce((a, r) => a + (r[ct] ?? 0), 0) }));
            dist.sort((a, b) => b.value - a.value);
            return dist;
        }

        function dominantCrime(rows) {
            const dist = crimeTypeDistribution(rows);
            return dist[0] ?? { type: "—", value: 0 };
        }

        function yoyForSelection(rows, crimeType) {
            // YoY uses last year in range vs previous year, if available
            const f = state.filters;
            const y2 = parseInt(f.yearTo);
            const y1 = y2 - 1;
            if (y1 < parseInt(f.yearFrom)) return { pct: NaN, delta: 0, a: 0, b: 0, y1, y2 }; const
                a = sumTotal(rows.filter(r => parseInt(r.Year) === y1), crimeType);
            const b = sumTotal(rows.filter(r => parseInt(r.Year) === y2), crimeType);
            const pct = a === 0 ? NaN : ((b - a) / a) * 100;
            return { pct, delta: b - a, a, b, y1, y2 };
        }

        function crimeRateIndex(rows, crimeType) {
            // synthetic rate per 100k based on state population sum (or per selection)
            const f = state.filters;
            let pop = 0;
            if (f.state !== "__all__") {
                pop = STATE_POP[f.state] ?? 50e6;
            } else {
                const states = Array.from(new Set(rows.map(r => r.State)));
                pop = states.reduce((a, s) => a + (STATE_POP[s] ?? 50e6), 0);
            }
            if (f.district !== "__all__") {
                // approximate district share
                pop = pop / 5; // since we used 5 districts/state in demo
            }
            const total = sumTotal(rows, crimeType);
            const rate = pop ? (total / pop) * 100000 : 0;
            return rate;
        }

        // -----------------------------
        // Charts
        // -----------------------------
        let lineChart, barChart, pieChart, heroMiniLine;

        function makeGradient(ctx, h, c1, c2) {
            const g = ctx.createLinearGradient(0, 0, 0, h);
            g.addColorStop(0, c1);
            g.addColorStop(1, c2);
            return g;
        }

        function chartDefaults() {
            Chart.defaults.color = "rgba(255,255,255,.78)";
            Chart.defaults.borderColor = "rgba(255,255,255,.10)";
            Chart.defaults.font.family = "Inter, system-ui, sans-serif";
            Chart.defaults.plugins.legend.labels.boxWidth = 10;
            Chart.defaults.plugins.legend.labels.boxHeight = 10;
            Chart.defaults.plugins.tooltip.backgroundColor = "rgba(15,23,42,.9)";
            Chart.defaults.plugins.tooltip.borderColor = "rgba(255,255,255,.14)";
            Chart.defaults.plugins.tooltip.borderWidth = 1;
            Chart.defaults.plugins.tooltip.titleColor = "rgba(255,255,255,.92)";
            Chart.defaults.plugins.tooltip.bodyColor = "rgba(255,255,255,.82)";
        }

        function buildLineChart(series) {
            const canvas = $("#lineChart");
            if (!canvas) return;
            const ctx = canvas.getContext("2d");
            // Red gradient
            const grad = makeGradient(ctx, 220, "rgba(220,38,38,.45)", "rgba(153,27,27,0)");

            if (lineChart) lineChart.destroy();

            lineChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: series.map(d => d.year),
                    datasets: [{
                        label: "Total Crimes",
                        data: series.map(d => d.value),
                        fill: true,
                        backgroundColor: grad,
                        borderColor: "rgba(248,113,113,.95)", // red-400
                        pointBackgroundColor: (ctx) => {
                            const year = ctx.raw?.x || series[ctx.dataIndex]?.year;
                            return PROJECTED_YEARS.includes(year) ? "#fca5a5" : "rgba(255,255,255,.9)";
                        },
                        pointBorderColor: (ctx) => {
                            const year = ctx.raw?.x || series[ctx.dataIndex]?.year;
                            return PROJECTED_YEARS.includes(year) ? "#fca5a5" : "rgba(248,113,113,.9)";
                        },
                        pointRadius: (ctx) => {
                            const year = ctx.raw?.x || series[ctx.dataIndex]?.year;
                            return PROJECTED_YEARS.includes(year) ? 5 : 3;
                        },
                        segment: {
                            borderDash: (ctx) => {
                                // Dash the line overlap if approaching projected year
                                // simpler: if p0 or p1 is projected
                                const p0 = series[ctx.p0DataIndex]?.year;
                                const p1 = series[ctx.p1DataIndex]?.year;
                                if (PROJECTED_YEARS.includes(p1)) return [6, 6];
                                return undefined;
                            },
                            borderColor: (ctx) => {
                                const p1 = series[ctx.p1DataIndex]?.year;
                                if (PROJECTED_YEARS.includes(p1)) return "rgba(252, 165, 165, 0.8)"; // Light red for prediction
                                return undefined;
                            }
                        },
                        tension: 0.35
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (ctx) => {
                                    const year = parseInt(ctx[0].label);
                                    return PROJECTED_YEARS.includes(year) ? `${year} (PROJECTION)` : year;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { ticks: { callback: (v) => (v >= 1000 ? (v / 1000).toFixed(1) + "k" : v) } }
                    }
                }
            });
        }

        function buildBarChart(labels, values) {
            const canvas = $("#barChart");
            if (!canvas) return;
            const ctx = canvas.getContext("2d");
            if (barChart) barChart.destroy();
            barChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels,
                    datasets: [{
                        label: "Total",
                        data: values,
                        backgroundColor: "rgba(220,38,38,.35)",
                        borderColor: "rgba(248,113,113,.45)",
                        borderWidth: 1.2,
                        borderRadius: 10,
                        maxBarThickness: 36
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: "rgba(255,255,255,.75)" } },
                        y: { ticks: { callback: (v) => (v >= 1000 ? (v / 1000).toFixed(1) + "k" : v) } }
                    }
                }
            });
        }

        function buildPieChart(dist) {
            const canvas = $("#pieChart");
            if (!canvas) return;
            const ctx = canvas.getContext("2d");
            if (pieChart) pieChart.destroy();
            const top = dist.slice(0, 6);
            const rest = dist.slice(6).reduce((a, b) => a + b.value, 0);
            const labels = top.map(d => d.type).concat(rest > 0 ? ["Others"] : []);
            const values = top.map(d => d.value).concat(rest > 0 ? [rest] : []);
            const colors = [
                "rgba(220,38,38,.75)", // red-600
                "rgba(234,88,12,.70)", // orange-600
                "rgba(245,158,11,.68)", // amber-500
                "rgba(185,28,28,.62)", // red-700
                "rgba(124,45,18,.62)", // orange-900
                "rgba(254,202,202,.62)",// red-200
                "rgba(148,163,184,.45)" // slate
            ];
            pieChart = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels, datasets: [{
                        data: values, backgroundColor: colors, borderColor:
                            "rgba(255,255,255,.10)", borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: "62%",
                    plugins: {
                        legend: { position: "bottom", labels: { color: "rgba(255,255,255,.78)" } },
                        tooltip: { callbacks: { label: (c) => `${c.label}: ${formatInt(c.parsed)}` } }
                    }
                }
            });
        }

        function buildHeroMini(series) {
            const canvas = $("#heroMiniLine");
            if (!canvas) return;
            const ctx = canvas.getContext("2d");
            const grad = makeGradient(ctx, 130, "rgba(220,38,38,.28)", "rgba(220,38,38,0)");
            if (heroMiniLine) heroMiniLine.destroy();
            heroMiniLine = new Chart(ctx, {
                type: "line",
                data: {
                    labels: series.map(d => d.year),
                    datasets: [{
                        data: series.map(d => d.value),
                        fill: true,
                        backgroundColor: grad,
                        borderColor: "rgba(220,38,38,.85)",
                        pointRadius: 0,
                        tension: 0.35
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        // -----------------------------
        // Map
        // -----------------------------

        let map, mapLayerGroup;
        function initMap() {
            if (!document.getElementById("map")) return;
            map = L.map('map', { zoomControl: true, scrollWheelZoom: false }).setView([22.5, 79], 4.6);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap & CARTO'
            }).addTo(map);

            mapLayerGroup = L.layerGroup().addTo(map);

            map.on("dblclick", () => {
                state.filters.state = "__all__";
                state.filters.district = "__all__";
                $("#stateSelect").value = "__all__";
                $("#districtSelect").value = "__all__";
                render();
            });
        }

        function intensityColor(v, max) {
            const t = max ? clamp(v / max, 0, 1) : 0;
            // Red scale (light red to deep dark red)
            // r=255, g goes down, b goes down
            // 254, 202, 202 (light) -> 127, 29, 29 (dark)
            const r = Math.round(254 + t * (127 - 254));
            const g = Math.round(202 + t * (29 - 202));
            const b = Math.round(202 + t * (29 - 202));
            return `rgba(${r},${g},${b},${0.5 + 0.4 * t})`;
        }

        function renderMap(rows) {
            if (!map || !mapLayerGroup) return;
            mapLayerGroup.clearLayers();
            const ct = state.filters.crimeType;

            // Decision: State View vs District View
            const isStateView = (state.filters.state === "__all__");

            if (isStateView) {
                // ------------------
                // STATE BUBBLES
                // ------------------
                const byState = groupBy(rows, "State", ct);
                const entries = Array.from(byState.entries());
                const max = entries.reduce((m, [, v]) => Math.max(m, v), 0);

                for (const [st, val] of entries) {
                    const c = STATE_CENTROIDS[st];
                    if (!c) continue;
                    const radius = 90000 + (max ? (val / max) * 180000 : 90000);

                    const circle = L.circle(c, {
                        radius,
                        color: "rgba(255,255,255,.20)",
                        weight: 1,
                        fillColor: intensityColor(val, max),
                        fillOpacity: 0.95
                    }).addTo(mapLayerGroup);

                    circle.bindTooltip(
                        `<div style="min-width:160px">
                    <div style="font-weight:700; margin-bottom:2px">${st}</div>
                    <div style="opacity:.85; font-size:12px">Total: <b>${formatInt(val)}</b></div>
                    <div style="opacity:.75; font-size:11px; margin-top:4px; color:#a5b4fc">Click to drill down</div>
                </div>`,
                        { sticky: true, direction: "top" }
                    );

                    circle.on("click", () => {
                        state.filters.state = st;
                        state.filters.district = "__all__";
                        $("#stateSelect").value = st;
                        $("#stateSelect").dispatchEvent(new Event("change")); // trigger refresh
                        render();
                    });
                }

                // Reset view to India center
                map.flyTo([22.5, 79], 4.6, { duration: 1.2 });

            } else {
                // ------------------
                // DISTRICT BUBBLES (Drill down)
                // ------------------
                const selectedState = state.filters.state;
                const center = STATE_CENTROIDS[selectedState];

                // Center map on state
                if (center) map.flyTo(center, 7, { duration: 1.2 });

                // Group by district for the filtered rows (which are already filtered by state)
                const byDistrict = groupBy(rows, "District", ct);
                const entries = Array.from(byDistrict.entries());
                const max = entries.reduce((m, [, v]) => Math.max(m, v), 0);

                // Deterministic RNG for placement stability
                const rng = mulberry32(selectedState.length * 42);

                for (const [dist, val] of entries) {
                    // Generate a pseudo-random position around the state center
                    // In a real app, we'd have a DISTRICT_COORDINATES table.
                    // Here, we scatter them within ~1.5 degrees of the state center.
                    if (!center) continue;

                    let lat, lng;
                    if (DISTRICT_COORDINATES[dist]) {
                        [lat, lng] = DISTRICT_COORDINATES[dist];
                    } else {
                        // Fallback: Generate a pseudo-random position around the state center

                        // Create a stable hash from string to keep position constant across renders
                        let hash = 0;
                        for (let i = 0; i < dist.length; i++) hash = dist.charCodeAt(i) + ((hash << 5) - hash);
                        const norm = (hash & 0xFFFFFF) / 0xFFFFFF; // 0..1 
                        const angle = norm * 2 * Math.PI;
                        const distOffset = 0.3 + (Math.abs(hash % 100) / 100) * 1.2; // 0.3 to 1.5 degrees 
                        lat = center[0] + distOffset * Math.cos(angle);
                        lng = center[1] + distOffset * Math.sin(angle);
                    }

                    const radius = 15000 + (max ? (val / max) * 40000 : 10000); // Smaller bubbles for districts
                    const isActive = (state.filters.district === dist);

                    const circle = L.circle([lat, lng], {
                        radius,
                        color: isActive ? "rgba(255,255,255,.9)" : "rgba(255,255,255,.3)",
                        weight: isActive ? 3 : 1,
                        fillColor: intensityColor(val, max),
                        fillOpacity: 0.9
                    }).addTo(mapLayerGroup);

                    circle.bindTooltip(`<div style="min-width:140px">
                    <div style="font-weight:700; margin-bottom:2px">${dist}</div>
                    <div style="opacity:.85; font-size:12px">Total: <b>${formatInt(val)}</b></div>
                    <div style="opacity:.65; font-size:10px; margin-top:2px">${state.filters.state}</div>
                    </div>`,
                        { sticky: true, direction: "top" }
                    );

                    circle.on("click", () => {
                        state.filters.district = dist;
                        $("#districtSelect").value = dist;
                        render(); // re-render to highlight selected/filter table
                    });
                }
            }
        }

        // -----------------------------
        // Table
        // -----------------------------
        function filteredTableRows(rows) {
            // Expand to "view rows": each data row becomes a view row with selected crime type
            const ct = state.filters.crimeType;
            const view = rows.map(r => {
                const type = ct === "__all__" ? "Total (All)" : ct;
                const val = ct === "__all__" ? r.Total : (r[ct] ?? 0);
                return {
                    State: r.State, District: r.District, Year: r.Year, Total: r.Total, CrimeType: type,
                    CrimeValue: val
                };
            });

            const q = state.tableSearch.trim().toLowerCase();
            let out = view;
            if (q) {
                out = out.filter(v =>
                    v.State.toLowerCase().includes(q) ||
                    v.District.toLowerCase().includes(q) ||
                    String(v.Year).includes(q) ||
                    v.CrimeType.toLowerCase().includes(q)
                );
            }
            return out;
        }

        function sortRows(rows) {
            const { key, dir } = state.sort;
            const mul = dir === "asc" ? 1 : -1;
            return rows.slice().sort((a, b) => {
                const va = a[key], vb = b[key];
                if (typeof va === "number" && typeof vb === "number") return (va - vb) * mul;
                return String(va).localeCompare(String(vb)) * mul;
            });
        }

        function renderTable(rows) {
            const tbody = $("#tableBody");
            if (!tbody) return;
            tbody.innerHTML = "";

            const view = sortRows(filteredTableRows(rows));
            const totalCount = view.length;

            const pages = Math.max(1, Math.ceil(totalCount / state.pageSize));
            state.page = clamp(state.page, 1, pages);

            const start = (state.page - 1) * state.pageSize;
            const slice = view.slice(start, start + state.pageSize);

            for (const r of slice) {
                const tr = document.createElement("tr");
                tr.className = "hover:bg-white/5 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${r.State}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${r.District}</td>
                    <td class="px-4 py-3">${r.Year}</td>
                    <td class="px-4 py-3">${formatInt(r.Total)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${r.CrimeType}</td>
                    <td class="px-4 py-3 text-right font-medium">${formatInt(r.CrimeValue)}</td>
                    `;
                tbody.appendChild(tr);
            }

            setTxt("#tableMeta", `${formatInt(totalCount)} rows (showing ${start + 1}-${Math.min(start +
                state.pageSize, totalCount)})`);
            setTxt("#pageInfo", `Page ${state.page} / ${pages}`);

            const btnPrev = $("#prevPageBtn");
            if (btnPrev) btnPrev.disabled = state.page <= 1; const btnNext = $("#nextPageBtn"); if (btnNext)
                btnNext.disabled = state.page >= pages;

            // sort indicators
            const keys = ["State", "District", "Year", "Total", "CrimeType", "CrimeValue"];
            for (const k of keys) {
                const el = $("#sort" + k);
                if (!el) continue;
                el.textContent = (state.sort.key === k) ? (state.sort.dir === "asc" ? " ▲" : " ▼") : "";
            }
        }

        // -----------------------------
        // Export
        // -----------------------------
        function toCSV(rows) {
            const headers = ["State", "District", "Year", ...CRIME_TYPES, "Total"];
            const lines = [headers.join(",")];
            for (const r of rows) {
                const arr = headers.map(h => {
                    const v = r[h];
                    if (typeof v === "string") {
                        const s = v.replaceAll('"', '""');
                        return `"${s}"`;
                    }
                    return String(v ?? "");
                });
                lines.push(arr.join(","));
            }
            return lines.join("\n");
        }

        function download(filename, content, mime) {
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 1500);
        }

        function exportCurrentCSV() {
            const rows = applyCurrentFilters();
            download("crimescope_export.csv", toCSV(rows), "text/csv;charset=utf-8");
        }

        function exportCurrentPDF() {
            const rows = applyCurrentFilters();
            const f = state.filters;
            const ct = f.crimeType === "__all__" ? "All crimes (Total)" : f.crimeType;
            const title = `CrimeScope Export — ${ct} — ${f.state === "__all__" ? "All states" :
                f.state}${f.district === "__all__" ? "" : (" / " + f.district)} — ${f.yearFrom}-${f.yearTo}`;
            const total = sumTotal(rows, f.crimeType);
            const yoy = yoyForSelection(rows, f.crimeType);
            const dom = dominantCrime(rows);
            const series = seriesByYear(rows, f.crimeType);

            const pre = `
                        ${title}

                        Total crimes: ${formatInt(total)}
                        YoY: ${isFinite(yoy.pct) ? formatPct(yoy.pct) : "—"} (${yoy.y1}→${yoy.y2})
                        Dominant crime: ${dom.type} (${formatInt(dom.value)})

                        Trend:
                        ${series.map(s => `${s.year}: ${formatInt(s.value)}`).join("\n")}

                        Notes:
                        - This is a lightweight PDF-like export as a printable document.
                        - In production, replace with jsPDF/html2pdf for richer output.
                        `;
            const w = window.open("", "_blank");
            w.document.write(`
                        <!DOCTYPE html>
                        <html>

                        <head>
                            <meta charset="utf-8" />
                            <meta name="viewport" content="width=device-width, initial-scale=1" />
                            <title>CrimeScope Export</title>
                            <style>
                                body {
                                    font-family: Inter, system-ui, sans-serif;
                                    padding: 24px;
                                    color: #0b1026;
                                }

                                h1 {
                                    font-size: 18px;
                                    margin: 0 0 10px;
                                }

                                pre {
                                    white-space: pre-wrap;
                                    font-size: 13px;
                                    line-height: 1.45;
                                    background: #f6f7fb;
                                    border: 1px solid #e6e8f0;
                                    padding: 14px;
                                    border-radius: 12px;
                                }

                                .muted {
                                    color: #4b5563;
                                    font-size: 12px;
                                    margin-top: 10px;
                                }

                                @media print {
                                    body {
                                        padding: 0
                                    }

                                    pre {
                                        border: none
                                    }
                                }
                            </style>
                        </head>

                        <body>
                            <h1>CrimeScope — Export</h1>
                            <pre>${pre.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")}</pre>
                            <div class="muted">Generated at ${new Date().toLocaleString()}</div>
                            <script>setTimeout(() => window.print(), 250); <\/script>
                                </body></html>
                                    `);
            w.document.close();
        }

        // -----------------------------
        // Render all
        // -----------------------------
        function render() {
            const rows = applyCurrentFilters();
            const f = state.filters;

            const ct = f.crimeType;

            const total = sumTotal(rows, ct);
            const rate = crimeRateIndex(rows, ct);
            const yoy = yoyForSelection(rows, ct);
            const dom = dominantCrime(rows);

            // top state meta
            const byState = groupBy(rows, "State", ct);
            let topState = "—", topVal = 0;
            for (const [k, v] of byState.entries()) {
                if (v > topVal) { topVal = v; topState = k; }
            }

            // Hero KPIs
            setTxt("#heroTotalCrimes", formatInt(total));
            setTxt("#heroCrimeRate", rate ? rate.toFixed(1) : "0.0");
            setTxt("#heroTopState", topState);
            setTxt("#heroTopStateMeta", topState === "—" ? "No data" : `${formatInt(topVal)} incidents`);

            const yoyTxt = isFinite(yoy.pct) ? formatPct(yoy.pct) : "—";
            setTxt("#heroYoyValue", yoyTxt);

            const arrow = $("#heroYoyArrow");
            if (arrow) {
                if (isFinite(yoy.pct)) {
                    const up = yoy.pct >= 0;
                    arrow.innerHTML = up
                        ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 19V5m0 0l-6 6m6-6l6 6" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>`
                        : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14m0 0l-6-6m6 6l6-6" stroke="rgba(255,255,255,.92)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>`;
                    arrow.className = "h-9 w-9 rounded-xl flex items-center justify-center border " + (up ? "bg-emerald-500/15 border-emerald-200/15" : "bg-rose-500/15 border-rose-200/15");
                } else {
                    arrow.textContent = "—";
                    arrow.className = "h-9 w-9 rounded-xl flex items-center justify-center bg-white/6 border border-white/10";
                }
            }

            setTxt("#heroDominant", dom.type);
            setTxt("#heroDominantMeta", `${formatInt(dom.value)} incidents`);

            // Dashboard KPIs
            setTxt("#kpiTotal", formatInt(total));

            const kpiYoy = $("#kpiTotalYoy");
            if (kpiYoy) {
                if (isFinite(yoy.pct)) {
                    const up = yoy.pct >= 0;
                    kpiYoy.textContent = `${up ? "▲" : "▼"} ${formatPct(yoy.pct)} `;
                    kpiYoy.style.borderColor = up ? "rgba(34,197,94,.35)" : "rgba(239,68,68,.35)";
                    kpiYoy.style.background = up ? "rgba(34,197,94,.12)" : "rgba(239,68,68,.12)";
                } else {
                    kpiYoy.textContent = "—";
                    kpiYoy.style.borderColor = "rgba(255,255,255,.14)";
                    kpiYoy.style.background = "rgba(255,255,255,.06)";
                }
            }

            setTxt("#kpiRate", rate ? rate.toFixed(1) : "0.0");

            // Use YoY pct as proxy delta
            const rd = $("#kpiRateDelta");
            if (rd) {
                if (isFinite(yoy.pct)) {
                    const up = yoy.pct >= 0;
                    rd.textContent = `${up ? "▲" : "▼"} ${formatPct(yoy.pct)} `;
                    rd.style.borderColor = up ? "rgba(34,197,94,.35)" : "rgba(239,68,68,.35)";
                    rd.style.background = up ? "rgba(34,197,94,.12)" : "rgba(239,68,68,.12)";
                } else {
                    rd.textContent = "—";
                    rd.style.borderColor = "rgba(255,255,255,.14)";
                    rd.style.background = "rgba(255,255,255,.06)";
                }
            }

            setTxt("#kpiTopState", topState);
            setTxt("#kpiTopStateMeta", topState === "—" ? "No data" : `${formatInt(topVal)} incidents`);

            setTxt("#kpiDominant", dom.type);
            setTxt("#kpiDominantMeta", `${formatInt(dom.value)} incidents`);

            // Active filter text
            const parts = [];
            parts.push(ct === "__all__" ? "All crimes (Total)" : ct);
            parts.push(f.state === "__all__" ? "All states" : f.state);
            if (f.district !== "__all__") parts.push(f.district);
            parts.push(`${f.yearFrom}–${f.yearTo} `);
            setTxt("#activeFilterText", parts.join(" • "));

            // Charts
            const series = seriesByYear(rows, ct);
            buildLineChart(series);
            buildHeroMini(series);

            const dist = crimeTypeDistribution(rows);
            buildPieChart(dist);

            // Top 10 bar
            const key = state.topMode === "state" ? "State" : "District";
            const grouped = Array.from(groupBy(rows, key, ct).entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            buildBarChart(grouped.map(x => x[0]), grouped.map(x => x[1]));

            // Map
            renderMap(rows);

            // Table
            renderTable(rows);
        }

        // -----------------------------
        // Events
        // -----------------------------
        function syncFiltersFromUI() {
            const s = $("#stateSelect").value;
            const d = $("#districtSelect").value;
            const ct = $("#crimeTypeSelect").value;
            let yFrom = parseInt($("#yearFromSelect").value, 10);
            let yTo = parseInt($("#yearToSelect").value, 10);
            if (yFrom > yTo) [yFrom, yTo] = [yTo, yFrom];

            state.filters.state = s;
            state.filters.district = d;
            state.filters.crimeType = ct;
            state.filters.yearFrom = yFrom;
            state.filters.yearTo = yTo;

            // Ensure district valid for selected state
            if (s !== "__all__" && d !== "__all__") {
                const ok = DATA.some(r => r.State === s && r.District === d);
                if (!ok) {
                    state.filters.district = "__all__";
                    $("#districtSelect").value = "__all__";
                }
            }
        }

        function updateYearSliderRange() {
            const predToggle = $("#predictionToggle");
            if (!predToggle) return;
            const showPred = predToggle.checked;

            // Update slider attributes
            $("#yearFromSelect").innerHTML = "";
            $("#yearToSelect").innerHTML = "";

            const availableYears = showPred ? YEARS : YEARS.filter(y => y <= 2023);

            for (const y of availableYears) {
                const o1 = document.createElement("option"); o1.value = y; o1.textContent = y; $("#yearFromSelect").appendChild(o1);
                const o2 = document.createElement("option"); o2.value = y; o2.textContent = y; $("#yearToSelect").appendChild(o2);
            }

            // Set values
            // If turning OFF, cap at 2023
            if (!showPred && state.filters.yearTo > 2023) {
                state.filters.yearTo = 2023;
            }
            // If turning ON, extend to 2028
            if (showPred && state.filters.yearTo < 2028) {
                state.filters.yearTo = 2028;
            }

            $("#yearFromSelect").value = state.filters.yearFrom;
            $("#yearToSelect").value = state.filters.yearTo;
        }

        function resetFilters() {
            // Respect prediction toggle
            if (typeof updateYearSliderRange === "function") updateYearSliderRange();

            const predToggle = $("#predictionToggle");
            const showPred = predToggle && predToggle.checked;
            const maxYear = showPred ? 2028 : 2023;

            state.filters = {
                state: "__all__",
                district: "__all__",
                crimeType: "__all__",
                yearFrom: 2017,
                yearTo: maxYear
            };
            $("#stateSelect").value = "__all__";
            $("#stateSelect").dispatchEvent(new Event("change"));
            $("#districtSelect").value = "__all__";
            $("#crimeTypeSelect").value = "__all__";
            $("#yearFromSelect").value = 2017;
            $("#yearToSelect").value = maxYear;

            state.page = 1;
            state.tableSearch = "";
            $("#tableSearch").value = "";
            render();
        }

        // -----------------------------
        // Mobile drawer: global
        // -----------------------------
        let drawerOpen = false;

        function openDrawer() {
            if (window.innerWidth >= 768) return;
            drawerOpen = true;
            const overlay = $("#overlay");
            const drawer = $("#mobileDrawer");
            if (overlay) overlay.classList.add("show");
            if (drawer) drawer.style.transform = "translateX(0)";

            // mount filters panel content
            const mount = $("#drawerFiltersMount");
            const panel = $("#filtersPanel");

            if (mount && panel) {
                mount.innerHTML = "";
                const clone = panel.cloneNode(true);
                clone.id = "filtersPanelClone";
                clone.classList.remove("h-fit");
                mount.appendChild(clone);

                // wire cloned buttons
                const mapId = (id) => clone.querySelector("#" + id);

                // Copy values
                ["stateSelect", "districtSelect", "crimeTypeSelect", "yearFromSelect", "yearToSelect"].forEach(id => {
                    const orig = $("#" + id);
                    const c = mapId(id);
                    if (orig && c) c.value = orig.value;
                });

                // Events
                const cState = mapId("stateSelect");
                if (cState) {
                    cState.addEventListener("change", () => {
                        const s = cState.value;
                        const dSel = mapId("districtSelect");
                        if (!dSel) return;
                        dSel.innerHTML = "";
                        const all = document.createElement("option");
                        all.value = "__all__"; all.textContent = "All districts";
                        dSel.appendChild(all);
                        const districts = (s === "__all__")
                            ? Array.from(new Set(DATA.map(d => d.District))).sort()
                            : Array.from(new Set(DATA.filter(r => r.State === s).map(r => r.District))).sort();
                        for (const d of districts) {
                            const opt = document.createElement("option");
                            opt.value = d; opt.textContent = d;
                            dSel.appendChild(opt);
                        }
                        dSel.value = "__all__";
                    });
                }

                const cApply = mapId("applyFiltersBtn");
                if (cApply) {
                    cApply.addEventListener("click", () => {
                        ["stateSelect", "districtSelect", "crimeTypeSelect", "yearFromSelect", "yearToSelect"].forEach(id => {
                            const orig = $("#" + id);
                            const c = mapId(id);
                            if (orig && c) orig.value = c.value;
                        });
                        const sSel = $("#stateSelect");
                        if (sSel) sSel.dispatchEvent(new Event("change"));
                        const dSel = $("#districtSelect");
                        const cDist = mapId("districtSelect");
                        if (dSel && cDist) {
                            const desiredDistrict = cDist.value;
                            if ([...dSel.options].some(o => o.value === desiredDistrict)) {
                                dSel.value = desiredDistrict;
                            } else {
                                dSel.value = "__all__";
                            }
                        }
                        syncFiltersFromUI();
                        state.page = 1;
                        render();
                        closeDrawer();
                    });
                }

                const cClear = mapId("clearFiltersBtn");
                if (cClear) {
                    cClear.addEventListener("click", () => {
                        resetFilters();
                        ["stateSelect", "districtSelect", "crimeTypeSelect", "yearFromSelect", "yearToSelect"].forEach(id => {
                            const orig = $("#" + id);
                            const c = mapId(id);
                            if (orig && c) c.value = orig.value;
                        });
                    });
                }
            }
        }

        function closeDrawer() {
            if (!drawerOpen) return;
            drawerOpen = false;
            const overlay = $("#overlay");
            const drawer = $("#mobileDrawer");
            const mount = $("#drawerFiltersMount");
            if (overlay) overlay.classList.remove("show");
            if (drawer) drawer.style.transform = "translateX(-100%)";
            if (mount) mount.innerHTML = "";
        }

        function toggleDrawer() {
            if (window.innerWidth >= 768) {
                const fp = document.getElementById("filtersPanel");
                if (fp) fp.scrollIntoView({ behavior: "smooth", block: "start" });
                return;
            }
            drawerOpen ? closeDrawer() : openDrawer();
        }

        function initUIEvents() {
            // Helper to safely bind events
            const bind = (sel, evt, fn) => {
                const el = $(sel);
                if (el) el.addEventListener(evt, fn);
            };
            const bindAll = (sel, evt, fn) => {
                $$(sel).forEach(el => el.addEventListener(evt, fn));
            };

            bind("#applyFiltersBtn", "click", async () => {
                const applyBtn = $("#applyFiltersBtn");
                const originalText = applyBtn.innerHTML;
                applyBtn.innerHTML = '<span class="animate-pulse">Analyzing via Python...</span>';

                syncFiltersFromUI();
                state.page = 1;
                render();

                // Fetch ML Prediction from Python backend
                try {
                    const s = state.filters.state === "__all__" ? "all" : state.filters.state;
                    const inputYear = parseInt($("#predictInputYear")?.value || (state.filters.yearTo + 1));
                    const pred = await window.ApiClient.getPrediction(s, inputYear);
                    if (pred && $("#kpiPrediction")) {
                        $("#kpiPrediction").textContent = formatInt(pred.predicted_crimes);
                        if ($("#predictModel")) $("#predictModel").textContent = pred.model_used;
                        if ($("#predictTargetYear")) $("#predictTargetYear").textContent = pred.target_year;
                    }
                } catch (e) {
                    console.error("Prediction API failed", e);
                }

                applyBtn.innerHTML = originalText;
                closeDrawer();
            });

            bind("#clearFiltersBtn", "click", resetFilters);
            bind("#ctaResetBtn", "click", resetFilters);

            const jumpToDash = () => {
                const el = document.getElementById("dashboard");
                if (el) el.scrollIntoView({ behavior: "smooth" });
            };
            bind("#ctaExploreBtn", "click", jumpToDash);
            bind("#jumpDashboardBtn", "click", jumpToDash);
            bind("#heroFocusBtn", "click", jumpToDash);

            bind("#exportCsvBtn", "click", exportCurrentCSV);
            bind("#downloadSampleBtn", "click", exportCurrentCSV);
            bind("#tableCsvBtn", "click", exportCurrentCSV);
            bind("#tablePdfBtn", "click", exportCurrentPDF);
            bind("#exportPdfBtn", "click", exportCurrentPDF);

            bind("#tableSearch", "input", (e) => {
                state.tableSearch = e.target.value;
                state.page = 1;
                render();
            });

            bind("#prevPageBtn", "click", () => {
                state.page -= 1;
                render();
            });
            bind("#nextPageBtn", "click", () => {
                state.page += 1;
                render();
            });

            // Sorting
            bindAll("thead th[data-sort]", "click", (e) => {
                const th = e.currentTarget;
                // Reset table sorting header indicators
                $$("thead th span.muted2").forEach(el => el.textContent = "");
                const activeTh = $(`thead th[data - sort= "${state.sort.key}"]span.muted2`);
                if (activeTh) activeTh.textContent = state.sort.dir === "asc" ? " ▲" : " ▼";

                // If a prediction update exists, it handles the Prediction KPI async
                // YoY calculations based on the live data (Filtered by the user state)
                const activeData = applyCurrentFilters(); // Get the currently filtered data
                const currentYear = state.filters.yearTo;
                const prevYear = currentYear - 1;

                // Calculate YoY for filtered data
                const cyData = activeData.filter(r => r.Year === currentYear);
                const pyData = activeData.filter(r => r.Year === prevYear);

                const cyTotal = sumTotal(cyData, state.filters.crimeType);
                const pyTotal = sumTotal(pyData, state.filters.crimeType);

                if (pyTotal > 0 && cyTotal !== pyTotal && pyTotal !== 0) {
                    const yoyPct = ((cyTotal - pyTotal) / pyTotal) * 100;
                    const heroYoy = $("#kpiTotalYoy");
                    if (heroYoy) heroYoy.textContent = formatPct(yoyPct);
                } else if ($("#kpiTotalYoy")) {
                    $("#kpiTotalYoy").textContent = "—";
                }
                if (state.sort.key === key) {
                    state.sort.dir = state.sort.dir === "asc" ? "desc" : "asc";
                } else {
                    state.sort.key = key;
                    state.sort.dir = (key === "State" || key === "District" || key === "CrimeType") ? "asc" : "desc";
                }
                render();
            });

            // Top mode toggle
            bind("#toggleTopModeBtn", "click", () => {
                state.topMode = state.topMode === "state" ? "district" : "state";
                const label = $("#topModeLabel");
                if (label) label.textContent = state.topMode === "state" ? "States" : "Districts";
                render();
            });

            // Keyboard shortcuts
            document.addEventListener("keydown", (e) => {
                if (e.key === "/" && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    e.preventDefault();
                    const s = $("#tableSearch");
                    if (s) s.focus();
                }
                if (e.key.toLowerCase() === "f" && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    e.preventDefault();
                    toggleDrawer();
                }
                if (e.key === "Escape") {
                    closeDrawer();
                }
            });

            // Prediction Toggle Logic
            bind("#predictionToggle", "change", () => {
                const checked = $("#predictionToggle").checked;
                if ($("#predictInputYear")) $("#predictInputYear").disabled = !checked;
                updateYearSliderRange();
                syncFiltersFromUI();
                render();
            });

            // Prediction Year Input Event
            bind("#predictInputYear", "change", async (e) => {
                const checked = $("#predictionToggle")?.checked;
                if (!checked) return;

                try {
                    const s = state.filters.state === "__all__" ? "all" : state.filters.state;
                    const val = parseInt(e.target.value);
                    if (val && val >= 2024) {
                        const pred = await window.ApiClient.getPrediction(s, val);
                        if (pred && $("#kpiPrediction")) {
                            $("#kpiPrediction").textContent = formatInt(pred.predicted_crimes);
                            if ($("#predictModel")) $("#predictModel").textContent = pred.model_used;
                            if ($("#predictTargetYear")) $("#predictTargetYear").textContent = pred.target_year;
                        }
                    }
                } catch (err) {
                    console.error("Manual Prediction Fetch Error:", err);
                }
            });

            // Mobile drawer
            bind("#mobileMenuBtn", "click", toggleDrawer);
            bind("#closeDrawerBtn", "click", closeDrawer);
            bind("#overlay", "click", closeDrawer);

            // Keep year bounds coherent
            bind("#yearFromSelect", "change", () => {
                const yf = $("#yearFromSelect");
                const yt = $("#yearToSelect");
                if (!yf || !yt) return;
                const a = parseInt(yf.value, 10);
                const b = parseInt(yt.value, 10);
                if (a > b) yt.value = a;
            });
            bind("#yearToSelect", "change", () => {
                const yf = $("#yearFromSelect");
                const yt = $("#yearToSelect");
                if (!yf || !yt) return;
                const a = parseInt(yf.value, 10);
                const b = parseInt(yt.value, 10);
                if (b < a) yf.value = b;
            });

            // Hotspot Modal Logic
            const modal = $("#hotspotModal");
            const content = $("#hotspotContent");

            function openHotspotModal() {
                if (!modal || !content) return;
                modal.classList.remove("opacity-0", "pointer-events-none");
                content.classList.remove("scale-95");
                content.classList.add("scale-100");
                populateHotspots();
            }

            function closeHotspotModal() {
                if (!modal || !content) return;
                modal.classList.add("opacity-0", "pointer-events-none");
                content.classList.remove("scale-100");
                content.classList.add("scale-95");
            }

            bind("#ctaHotspotsBtn", "click", openHotspotModal);
            bind("#closeHotspotBtn", "click", closeHotspotModal);

            // Close on outside click
            if (modal) {
                modal.addEventListener("click", (e) => {
                    if (e.target === modal) closeHotspotModal();
                });
            }

            function populateHotspots() {
                // Get latest year data (2023 or 2024 if avail)
                const yearTarget = 2023;
                const yearPrev = 2022;

                // 1. Rising Risk (Highest % increase 2022->2023)
                // Group by district to get totals
                const dTotalsCurrent = new Map();
                const dTotalsPrev = new Map();

                DATA.forEach(r => {
                    if (r.Year === yearTarget) dTotalsCurrent.set(r.District, (dTotalsCurrent.get(r.District) || 0) + r.Total);
                    if (r.Year === yearPrev) dTotalsPrev.set(r.District, (dTotalsPrev.get(r.District) || 0) + r.Total);
                });

                const deltas = [];
                for (const [d, val] of dTotalsCurrent.entries()) {
                    const prev = dTotalsPrev.get(d) || 0;
                    if (prev > 100) { // Filter out small base
                        const pct = ((val - prev) / prev) * 100;
                        // find state for this district
                        const row = DATA.find(r => r.District === d);
                        deltas.push({ d, s: row.State, pct, val, prev });
                    }
                }

                deltas.sort((a, b) => b.pct - a.pct);
                const topRising = deltas.slice(0, 5);

                const risingList = $("#risingRiskList");
                if (risingList) {
                    risingList.innerHTML = topRising.map((item, i) => `
                                    < div class="flex items-center justify-between p-2 rounded-lg bg-white/5 border border-white/5" >
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-slate-500">#${i + 1}</span>
                    <div>
                        <div class="text-xs font-medium text-white">${item.d} <span class="text-slate-500">(${item.s})</span></div>
                        <div class="text-[10px] text-slate-400">${formatInt(item.prev)} ➝ ${formatInt(item.val)}</div>
                    </div>
                </div>
                <div class="text-xs font-bold text-rose-400">+${item.pct.toFixed(1)}%</div>
            </div >
                                    `).join("");
                }

                // 2. Safest Regions (Lowest Rate per 100k - approximated using our synthetic pop)
                // We need district population. Using our synthetic STATE_POP / 5 assumption for consistency
                const rates = [];
                for (const [d, val] of dTotalsCurrent.entries()) {
                    const row = DATA.find(r => r.District === d);
                    const pop = (STATE_POP[row.State] || 50e6) / 5;
                    const rate = (val / pop) * 100000;
                    rates.push({ d, s: row.State, rate, val });
                }
                rates.sort((a, b) => a.rate - b.rate);
                const topSafe = rates.slice(0, 5);

                const safeList = $("#safestZonesList");
                if (safeList) {
                    safeList.innerHTML = topSafe.map((item, i) => `
                                    < div class="flex items-center justify-between p-2 rounded-lg bg-white/5 border border-white/5" >
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-slate-500">#${i + 1}</span>
                    <div>
                        <div class="text-xs font-medium text-white">${item.d} <span class="text-slate-500">(${item.s})</span></div>
                        <div class="text-[10px] text-slate-400">Total Incidents: ${formatInt(item.val)}</div>
                    </div>
                </div>
                <div class="text-xs font-bold text-emerald-400">${item.rate.toFixed(1)} <span class="text-[10px] text-slate-500 font-normal">/100k</span></div>
            </div >
                                    `).join("");
                }

                // 3. Category Hotspots (Top District for specific crimes)
                const cats = ["Cyber Crime", "Robbery", "Kidnapping"];
                let catHtml = "";

                cats.forEach(cType => {
                    // Find max district for this crime in 2023
                    let maxVal = 0;
                    let maxDist = "";
                    let maxState = "";

                    DATA.filter(r => r.Year === yearTarget).forEach(r => {
                        if (r[cType] > maxVal) {
                            maxVal = r[cType];
                            maxDist = r.District;
                            maxState = r.State;
                        }
                    });

                    catHtml += `
                                    < div class="bg-slate-950/50 p-3 rounded-lg border border-white/10" >
                    <div class="text-[10px] uppercase tracking-wider text-slate-400 mb-1">${cType} Pivot</div>
                    <div class="text-sm font-bold text-white truncate" title="${maxDist}">${maxDist}</div>
                    <div class="text-[10px] text-slate-500">${maxState}</div>
                    <div class="mt-2 text-xs font-mono text-orange-300">${formatInt(maxVal)} cases</div>
                </div >
             `;
                });

                const catGrid = $("#categoryHotspotsGrid");
                if (catGrid) catGrid.innerHTML = catHtml;
            }
        }

        // -----------------------------
        // Mobile drawer: clone filters


        // -----------------------------
        // Init
        // -----------------------------
        async function initDashboard() {
            try {
                // Fetch the live analytic dataset from the Python Backend
                const applyBtn = document.getElementById('applyFiltersBtn');
                if (applyBtn) applyBtn.innerHTML = '<span class="animate-pulse">Loading API...</span>';

                if (window.ApiClient) {
                    DATA = await window.ApiClient.getDataset();
                } else {
                    console.error("ApiClient not found!");
                }

                if (applyBtn) applyBtn.innerHTML = 'Apply Filters';

                chartDefaults();

                // Set default YEARS boundaries BEFORE init filters based on the dataset if valid
                if (DATA && DATA.length > 0) {
                    const datasetYears = Array.from(new Set(DATA.map(d => parseInt(d.Year)))).sort();
                    if (datasetYears.length > 0) YEARS = datasetYears;
                }

                initFilters();
                initMap();
                initUIEvents();

                // Initialize slider state based on default toggle
                if (typeof updateYearSliderRange === "function") updateYearSliderRange();

                resetFilters(); // sets UI + initial render

                try {
                    // Fetch initial ML Prediction based on input value
                    const initYear = parseInt($("#predictInputYear")?.value || (state.filters.yearTo + 1));
                    const pred = await window.ApiClient.getPrediction("all", initYear);
                    if (pred && document.getElementById("kpiPrediction")) {
                        document.getElementById("kpiPrediction").textContent = formatInt(pred.predicted_crimes);
                        if (document.getElementById("predictModel")) {
                            document.getElementById("predictModel").textContent = pred.model_used;
                        }
                        if (document.getElementById("predictTargetYear")) document.getElementById("predictTargetYear").textContent = pred.target_year;
                    }
                } catch (e) { }

            } catch (e) {
                console.error("Dashboard Init Error:", e);
                // Fallback gracefully without alerting repeatedly
            }
        }

        // Execute immediately since script is at the bottom of <body>
        initDashboard();
    </script>
</body>

</html>